<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Catalyst Core: Character Tracker (Clean)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0e1117;--surface:#151a23;--text:#e5e7eb;--muted:#9aa3af;--accent:#3cc6ff;--accent-2:#2563eb;--line:rgba(255,255,255,.12);--shadow:0 8px 28px rgba(0,0,0,.35)}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Arial,sans-serif;-webkit-font-smoothing:antialiased}
header{position:sticky;top:0;z-index:20;background:var(--surface);box-shadow:var(--shadow);padding:calc(12px + env(safe-area-inset-top)) 14px 12px}
.top{display:flex;align-items:center;justify-content:space-between;gap:10px}
h1{margin:0;font-size:1.1rem;color:var(--accent);font-weight:700}
.actions{display:flex;gap:8px}
.icon{width:40px;height:40px;border-radius:10px;background:#0b0f16;border:1px solid var(--accent);color:var(--accent);display:inline-flex;align-items:center;justify-content:center}
.icon:active{transform:translateY(1px)}
.tabs{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.tab{flex:1 0 110px;padding:10px 12px;border-radius:10px;border:1px solid var(--accent);background:#0b0f16;color:var(--text);font-weight:700;text-align:center}
.tab.active{background:var(--accent);color:#041319}
main{max-width:980px;margin:16px auto;padding:0 12px calc(16px + env(safe-area-inset-bottom))}
section{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
section h2{margin:0 0 10px;color:var(--accent);font-size:1.05rem}
.grid{display:grid;gap:12px}
.grid-1{grid-template-columns:1fr}
.grid-2{grid-template-columns:1fr}
.grid-3{grid-template-columns:1fr}
@media(min-width:820px){.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}}
label{display:block;font-weight:700;margin-bottom:6px}
input,select,textarea,button{width:100%;border-radius:12px;border:1px solid var(--accent);background:#0b0f16;color:var(--text);padding:12px}
button{background:var(--accent);color:#041319;border:none;font-weight:700;min-height:44px;cursor:pointer}
button:active{transform:translateY(1px)}
.btn-sm{min-height:36px;padding:8px 10px;border-radius:10px}
.inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;padding:6px 10px;border:1px solid var(--accent);border-radius:999px;color:var(--accent);font-size:.85rem;white-space:nowrap}
.card{border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
.catalog{max-height:360px;overflow:auto;border:1px dashed var(--line);border-radius:10px;padding:6px}
.catalog-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border-bottom:1px solid var(--line)}
.catalog-item:last-child{border-bottom:none}
.small{font-size:.9rem;color:var(--muted)}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:1000;padding:16px}
.overlay.hidden{display:none!important}
.modal{background:var(--surface);border:1px solid var(--accent);border-radius:16px;max-width:720px;width:100%;padding:16px;box-shadow:var(--shadow);position:relative}
.modal h3{margin:0 0 8px;color:var(--accent)}
.modal .x{position:absolute;top:8px;right:10px;background:transparent;border:none;color:inherit;font-size:1.4rem;line-height:1;cursor:pointer}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.toast{position:fixed;bottom:18px;right:18px;background:var(--surface);border:1px solid var(--accent);padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:opacity .2s,transform .2s;z-index:2000}
.toast.show{opacity:1;transform:translateY(0)}
@media print{header,.tabs,.actions,.overlay{display:none!important} body{background:#fff;color:#000} section{box-shadow:none;border:1px solid #ccc} .pill{border-color:#000;color:#000}}
</style>
</head>
<body>

<!-- Firebase config -->
<script id="firebase-config" type="application/json">
{
  "apiKey": "AIzaSyAYENVrM2komgm2Nteg388YewLiVuUOlIw",
  "authDomain": "catalyst-core-e458c.firebaseapp.com",
  "databaseURL": "https://catalyst-core-e458c-default-rtdb.firebaseio.com",
  "projectId": "catalyst-core-e458c",
  "storageBucket": "catalyst-core-e458c.firebasestorage.app",
  "messagingSenderId": "494771671712",
  "appId": "1:494771671712:web:0587e669cd5f7d3be92fc5",
  "measurementId": "G-R3JS5GWKFM"
}
</script>

<header>
  <div class="top">
    <h1>Catalyst Core: Character Tracker</h1>
    <div class="actions">
      <button id="btn-enc" class="icon" title="Encounter / Initiative">â‰¡</button>
      <button id="btn-load" class="icon" title="Load">â¤“</button>
      <button id="btn-save" class="icon" title="Save">â¤’</button>
      <button id="btn-log"  class="icon" title="Roll/Flip Log">â˜°</button>
      <button id="btn-rules" class="icon" title="Open Rules (CCCG)">ðŸ“–</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-go="combat">Combat</button>
    <button class="tab" data-go="abilities">Abilities</button>
    <button class="tab" data-go="powers">Powers</button>
    <button class="tab" data-go="gear">Gear</button>
    <button class="tab" data-go="story">Story</button>
  </div>
</header>

<main>
  <!-- COMBAT -->
  <section data-tab="combat">
    <h2>Tools</h2>
    <div class="grid grid-2">
      <div class="card">
        <label>Dice Roller</label>
        <div class="inline">
          <select id="dice-sides"><option>4</option><option>6</option><option>8</option><option>10</option><option>12</option><option selected>20</option><option>100</option></select>
          <input id="dice-count" type="number" inputmode="numeric" min="1" value="1" style="max-width:120px"/>
          <button id="roll-dice" style="max-width:160px">Roll</button>
        </div>
        <div class="small" id="dice-out"></div>
      </div>
      <div class="card">
        <label>Coin Flip</label>
        <div class="inline">
          <button id="flip">Flip</button>
          <span class="pill" id="flip-out"></span>
        </div>
      </div>
    </div>
  </section>

  <section data-tab="combat">
    <h2>Combat Stats</h2>
    <div class="grid grid-2">
      <div class="card">
        <label>HP</label>
        <div class="inline">
          <progress id="hp-bar" max="10" value="10" style="width:100%"></progress>
          <span class="pill" id="hp-pill">10/10</span>
        </div>
        <div class="inline">
          <input id="hp-roll" type="number" inputmode="numeric" placeholder="Tier Roll"/>
          <input id="hp-bonus" type="number" inputmode="numeric" placeholder="Bonus HP"/>
        </div>
        <div class="inline">
          <input id="hp-temp" type="number" inputmode="numeric" placeholder="Temp HP"/>
          <input id="hp-amt" type="number" inputmode="numeric" placeholder="Amount"/>
          <button id="hp-dmg" class="btn-sm">Damage</button>
          <button id="hp-heal" class="btn-sm">Heal</button>
          <button id="hp-full" class="btn-sm">Reset HP</button>
        </div>
      </div>
      <div class="card">
        <label>SP</label>
        <div class="inline">
          <progress id="sp-bar" max="5" value="5" style="width:100%"></progress>
          <span class="pill" id="sp-pill">5/5</span>
        </div>
        <div class="inline">
          <input id="sp-temp" type="number" inputmode="numeric" placeholder="Temp SP"/>
          <button class="btn-sm" data-sp="-1">-1 SP</button>
          <button class="btn-sm" data-sp="-2">-2 SP</button>
          <button class="btn-sm" data-sp="-3">-3 SP</button>
          <button id="sp-full" class="btn-sm">Reset SP</button>
        </div>
        <div class="inline"><button id="long-rest" class="btn-sm">Long Rest</button></div>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <label>Initiative</label>
        <input id="initiative" type="number" inputmode="numeric" placeholder="auto from DEX + bonuses" readonly/>
        <label>Speed (ft)</label>
        <input id="speed" type="number" inputmode="numeric" placeholder="30"/>
      </div>
      <div class="card">
        <label>Passive Perception</label>
        <input id="pp" type="number" readonly/>
        <label>Armor/Shield Bonus (auto)</label>
        <input id="armor-bonus" type="number" readonly/>
        <label>Power/Origin Bonus</label>
        <input id="origin-bonus" type="number" inputmode="numeric" value="0"/>
        <label>TC</label>
        <input id="tc" type="number" readonly/>
      </div>
    </div>
  </section>

  <!-- ABILITIES -->
  <section data-tab="abilities">
    <h2>Ability Scores</h2>
    <div class="grid grid-3" id="abil-grid"></div>
    <div class="card">
      <div class="inline">
        <div style="flex:1">
          <label>Proficiency Bonus</label>
          <input id="prof-bonus" type="number" inputmode="numeric" value="2"/>
        </div>
        <div style="flex:1">
          <label>Power Save Ability</label>
          <select id="power-save-ability">
            <option value="str">STR</option><option value="dex">DEX</option><option value="con">CON</option>
            <option value="int">INT</option><option value="wis" selected>WIS</option><option value="cha">CHA</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Power Save DC</label>
          <input id="power-save-dc" type="number" readonly/>
        </div>
      </div>
    </div>
  </section>

  <!-- POWERS -->
  <section data-tab="powers">
    <div class="inline" style="justify-content:space-between">
      <h2>Powers</h2>
      <button id="add-power" style="max-width:180px">Add Power</button>
    </div>
    <div class="grid grid-2" id="powers"></div>

    <div class="inline" style="justify-content:space-between;margin-top:8px">
      <h2>Signature Moves</h2>
      <button id="add-sig" style="max-width:200px">Add Signature Move</button>
    </div>
    <div class="grid grid-2" id="sigs"></div>
  </section>

  <!-- GEAR -->
  <section data-tab="gear">
    <h2>Gear</h2>
    <div class="grid grid-2">
      <div class="card">
        <div class="inline" style="justify-content:space-between">
          <label>Weapons</label><button id="add-weapon" class="btn-sm" style="max-width:140px">Add Weapon</button>
        </div>
        <div id="weapons" class="grid grid-1"></div>
      </div>
      <div class="card">
        <div class="inline" style="justify-content:space-between">
          <label>Armor & Protection</label><button id="add-armor" class="btn-sm" style="max-width:160px">Add Armor</button>
        </div>
        <div id="armors" class="grid grid-1"></div>
      </div>
      <div class="card" style="grid-column:1/-1">
        <div class="inline" style="justify-content:space-between">
          <label>Gear & Items</label>
          <div class="inline">
            <button id="add-item" class="btn-sm" style="max-width:140px">Add Item</button>
            <button id="open-catalog" class="btn-sm" style="max-width:160px">Open Gear Catalog</button>
          </div>
        </div>
        <div id="items" class="grid grid-1"></div>
      </div>
    </div>
  </section>

  <!-- STORY -->
  <section data-tab="story">
    <h2>Character & Story</h2>
    <div class="grid grid-2">
      <div class="card"><label>Superhero Identity</label><input id="superhero" placeholder="Vigil name"/></div>
      <div class="card"><label>Secret Identity</label><input id="secret" placeholder="Real name"/></div>
      <div class="card">
        <label>Public Identity</label>
        <select id="publicIdentity"><option value="Public">Public</option><option value="Secret" selected>Secret</option></select>
      </div>
      <div class="card">
        <label>Tier</label>
        <select id="tier">
          <option>Tier 5 â€“ Rookie</option>
          <option>Tier 4 â€“ Emerging Vigilante</option>
          <option>Tier 3 â€“ Field-Tested Operative</option>
          <option>Tier 2 â€“ Respected Force</option>
          <option>Tier 1 â€“ Heroic Figure</option>
          <option>Tier 0 â€“ Transcendent</option>
        </select>
      </div>
      <div class="card">
        <label>Alignment</label>
        <select id="alignment">
          <option>Paragon (Lawful Light)</option>
          <option>Guardian (Neutral Light)</option>
          <option>Vigilante (Chaotic Light)</option>
          <option>Sentinel (Lawful Neutral)</option>
          <option>Outsider (True Neutral)</option>
          <option>Wildcard (Chaotic Neutral)</option>
          <option>Inquisitor (Lawful Shadow)</option>
          <option>Anti-Hero (Neutral Shadow)</option>
          <option>Renegade (Chaotic Shadow)</option>
        </select>
      </div>
      <div class="card">
        <label>Classification</label>
        <select id="classification">
          <option>Mutant</option><option>Enhanced Human</option><option>Magic User</option><option>Alien/Extraterrestrial</option><option>Mystical Being</option>
        </select>
      </div>
      <div class="card">
        <label>Primary Power Style</label>
        <select id="power-style">
          <option>Physical Powerhouse</option><option>Energy Manipulator</option><option>Speedster</option>
          <option>Telekinetic/Psychic</option><option>Illusionist</option><option>Shape-shifter</option><option>Elemental Controller</option>
        </select>
      </div>
      <div class="card">
        <label>Secondary Power Style</label>
        <select id="power-style-2">
          <option>None</option>
          <option>Physical Powerhouse</option><option>Energy Manipulator</option><option>Speedster</option>
          <option>Telekinetic/Psychic</option><option>Illusionist</option><option>Shape-shifter</option><option>Elemental Controller</option>
        </select>
      </div>
    </div>

    <div class="card">
      <label>Backstory / Notes</label>
      <textarea id="story-notes" rows="6" placeholder="Key events, allies, vulnerabilities, research/training notes, etc."></textarea>
    </div>
  </section>
</main>

<!-- INITIATIVE MODAL -->
<div class="overlay hidden" id="modal-enc">
  <div class="modal">
    <button class="x" data-close>Ã—</button>
    <h3>Encounter Tracker</h3>
    <div class="inline" style="margin-bottom:6px"><span class="pill" id="round-pill">Round 1</span></div>
    <div class="inline">
      <input id="enc-name" placeholder="Name"/>
      <input id="enc-init" type="number" inputmode="numeric" placeholder="Init"/>
      <button id="enc-add" class="btn-sm">Add</button>
    </div>
    <div id="enc-list" class="catalog" style="margin-top:8px"></div>
    <div class="actions">
      <button id="enc-next" class="btn-sm">Next Round</button>
      <button id="enc-reset" class="btn-sm">Reset</button>
    </div>
  </div>
</div>

<!-- LOG MODAL -->
<div class="overlay hidden" id="modal-log">
  <div class="modal">
    <button class="x" data-close>Ã—</button>
    <h3>Recent Log</h3>
    <div class="grid grid-2">
      <div><label>Dice</label><div id="log-dice" class="catalog"></div></div>
      <div><label>Coins</label><div id="log-coin" class="catalog"></div></div>
    </div>
    <div class="actions"><button class="btn-sm" data-close>Close</button></div>
  </div>
</div>

<!-- SAVE / LOAD -->
<div class="overlay hidden" id="modal-save">
  <div class="modal">
    <button class="x" data-close>Ã—</button>
    <h3>Save Character</h3>
    <label>Save name</label>
    <input id="save-key" placeholder="e.g., Shawn"/>
    <div class="actions"><button id="do-save">Save</button></div>
  </div>
</div>
<div class="overlay hidden" id="modal-load">
  <div class="modal">
    <button class="x" data-close>Ã—</button>
    <h3>Load Character</h3>
    <label>Save name</label>
    <input id="load-key" placeholder="Enter save name"/>
    <div class="actions"><button id="do-load">Load</button></div>
  </div>
</div>

<!-- GEAR CATALOG -->
<div class="overlay hidden" id="modal-catalog">
  <div class="modal" style="max-width:900px">
    <button class="x" data-close>Ã—</button>
    <h3>Gear Catalog</h3>
    <div class="inline" style="margin:6px 0">
      <select id="catalog-filter-style" style="max-width:260px"></select>
      <select id="catalog-filter-type" style="max-width:180px"><option value="">All Types</option><option>Armor</option><option>Shield</option><option>Utility</option></select>
      <select id="catalog-filter-rarity" style="max-width:160px"><option value="">All Rarities</option><option>Common</option><option>Uncommon</option><option>Rare</option><option>Elite</option><option>Legendary</option></select>
      <input id="catalog-search" placeholder="Search..."/>
    </div>
    <div id="catalog-list" class="catalog"></div>
  </div>
</div>

<!-- RULES (CCCG PDF) -->
<div class="overlay hidden" id="modal-rules">
  <div class="modal" style="max-width:960px;height:80vh">
    <button class="x" data-close>Ã—</button>
    <h3>CCCG â€” Character Creation Guide</h3>
    <div style="height:calc(100% - 40px)">
      <iframe src="./CCCCG - Catalyst Core Character Creation Guide.pdf" title="CCCG PDF" style="width:100%;height:100%;border:1px solid var(--line);border-radius:8px"></iframe>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { $, qs, qsa, num, mod, updateDerived } from './updateDerived.js';
/* ========= helpers ========= */
function show(id){ $(id).classList.remove('hidden'); }
function hide(id){ $(id).classList.add('hidden'); }
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

/* ========= tabs ========= */
function setTab(name){
  qsa('section[data-tab]').forEach(s=> s.style.display = s.getAttribute('data-tab')===name ? 'block':'none');
  qsa('.tab').forEach(b=> b.classList.toggle('active', b.getAttribute('data-go')===name));
}
qsa('.tab').forEach(b=> b.addEventListener('click', ()=> setTab(b.getAttribute('data-go'))));
setTab('combat');

/* ========= ability grid + autos ========= */
const ABILS = ['str','dex','con','int','wis','cha'];
const abilGrid = $('abil-grid');
abilGrid.innerHTML = ABILS.map(a=>`
  <div class="card">
    <label>${a.toUpperCase()}</label>
    <div class="inline"><select id="${a}"></select><span class="pill" id="${a}-mod">+0</span></div>
  </div>`).join('');
ABILS.forEach(a=>{ const sel=$(a); for(let v=10; v<=24; v++) sel.add(new Option(v,v)); sel.value='10'; });
ABILS.forEach(a=> $(a).addEventListener('change', updateDerived));
['hp-roll','hp-bonus','hp-temp','origin-bonus','prof-bonus','power-save-ability'].forEach(id=> $(id).addEventListener('input', updateDerived));

/* ========= HP/SP controls ========= */
function setHP(v){ const hb=$('hp-bar'); hb.value = Math.max(0, Math.min(num(hb.max), v)); $('hp-pill').textContent = `${num(hb.value)}/${num(hb.max)}` + (num($('hp-temp').value)?` (+${num($('hp-temp').value)})`:``); }
function setSP(v){ const sb=$('sp-bar'); sb.value = Math.max(0, Math.min(num(sb.max), v)); $('sp-pill').textContent = `${num(sb.value)}/${num(sb.max)}`; }
$('hp-dmg').addEventListener('click', ()=>{ let d=num($('hp-amt').value); if(!d) return; let tv=num($('hp-temp').value); if(d>0 && tv>0){ const use=Math.min(tv,d); tv-=use; $('hp-temp').value=tv; d-=use; } setHP(num($('hp-bar').value)-d); });
$('hp-heal').addEventListener('click', ()=>{ const d=num($('hp-amt').value)||0; setHP(num($('hp-bar').value)+d); });
$('hp-full').addEventListener('click', ()=> setHP(num($('hp-bar').max)));
$('sp-full').addEventListener('click', ()=> setSP(num($('sp-bar').max)));
qsa('[data-sp]').forEach(b=> b.addEventListener('click', ()=> setSP(num($('sp-bar').value) + num(b.dataset.sp)||0) ));
$('long-rest').addEventListener('click', ()=>{ setHP(num($('hp-bar').max)); setSP(num($('sp-bar').max)); });

/* ========= Dice/Coin + Logs ========= */
const diceLog = JSON.parse(localStorage.getItem('dice-log')||'[]');
const coinLog = JSON.parse(localStorage.getItem('coin-log')||'[]');
const fmt = (ts)=>new Date(ts).toLocaleTimeString();
function pushLog(arr, entry, key){ arr.push(entry); if (arr.length>30) arr.splice(0, arr.length-30); localStorage.setItem(key, JSON.stringify(arr)); }
function renderLogs(){
  $('log-dice').innerHTML = diceLog.slice(-10).reverse().map(e=>`<div class="catalog-item"><div>${fmt(e.t)}</div><div><b>${e.text}</b></div></div>`).join('');
  $('log-coin').innerHTML = coinLog.slice(-10).reverse().map(e=>`<div class="catalog-item"><div>${fmt(e.t)}</div><div><b>${e.text}</b></div></div>`).join('');
}
$('roll-dice').addEventListener('click', ()=>{
  const s = num($('dice-sides').value), c=num($('dice-count').value)||1;
  const rolls = Array.from({length:c}, ()=> 1+Math.floor(Math.random()*s));
  const sum = rolls.reduce((a,b)=>a+b,0);
  $('dice-out').textContent = `Rolls: ${rolls.join(', ')} (Sum: ${sum})`;
  pushLog(diceLog, {t:Date.now(), text:`${c}Ã—d${s}: ${rolls.join(', ')} = ${sum}`}, 'dice-log');
});
$('flip').addEventListener('click', ()=>{
  const v = Math.random()<.5 ? 'Heads' : 'Tails';
  $('flip-out').textContent = v;
  pushLog(coinLog, {t:Date.now(), text:v}, 'coin-log');
});
$('btn-log').addEventListener('click', ()=>{ renderLogs(); show('modal-log'); });
qsa('[data-close]').forEach(b=> b.addEventListener('click', ()=> b.closest('.overlay')?.classList.add('hidden') ));

/* ========= Powers & Signature Moves ========= */
function cardPower(pref={}){ const d=document.createElement('div'); d.className='card'; d.dataset.kind='power';
  d.innerHTML=`<div class="inline">
      <input data-f="name" placeholder="Power Name" value="${pref.name||''}"/>
      <input data-f="sp" placeholder="SP" style="max-width:100px" value="${pref.sp||''}"/>
      <input data-f="save" placeholder="Save" style="max-width:160px" value="${pref.save||''}"/>
      <input data-f="range" placeholder="Range" style="max-width:160px" value="${pref.range||''}"/>
    </div>
    <textarea data-f="effect" rows="3" placeholder="Effect">${pref.effect||''}</textarea>
    <div class="inline"><button class="btn-sm" data-act="del">Delete</button></div>`;
  d.querySelector('[data-act="del"]').addEventListener('click', ()=> d.remove());
  return d;}
function cardSig(pref={}){ const d=document.createElement('div'); d.className='card'; d.dataset.kind='sig';
  d.innerHTML=`<div class="inline">
      <input data-f="name" placeholder="Signature Name" value="${pref.name||''}"/>
      <input data-f="sp" placeholder="SP" style="max-width:100px" value="${pref.sp||''}"/>
      <input data-f="save" placeholder="Save" style="max-width:160px" value="${pref.save||''}"/>
      <input data-f="special" placeholder="Special" style="max-width:200px" value="${pref.special||''}"/>
    </div>
    <textarea data-f="desc" rows="3" placeholder="Effect / Visual Description">${pref.desc||''}</textarea>
    <div class="inline"><button class="btn-sm" data-act="del">Delete</button></div>`;
  d.querySelector('[data-act="del"]').addEventListener('click', ()=> d.remove());
  return d;}
$('add-power').addEventListener('click', ()=> $('powers').appendChild(cardPower()));
$('add-sig').addEventListener('click', ()=> $('sigs').appendChild(cardSig()));

/* ========= Gear ========= */
function cardWeapon(pref={}){ const d=document.createElement('div'); d.className='card'; d.dataset.kind='weapon';
  d.innerHTML=`<div class="inline">
      <input data-f="name" placeholder="Name" value="${pref.name||''}"/>
      <input data-f="damage" placeholder="Damage" style="max-width:140px" value="${pref.damage||''}"/>
      <input data-f="range" placeholder="Range" style="max-width:160px" value="${pref.range||''}"/>
    </div>
    <div class="inline"><button class="btn-sm" data-act="del">Delete</button></div>`;
  d.querySelector('[data-act="del"]').addEventListener('click', ()=> d.remove());
  return d;}
function cardArmor(pref={}){ const d=document.createElement('div'); d.className='card'; d.dataset.kind='armor';
  d.innerHTML=`<div class="inline">
      <input data-f="name" placeholder="Name" value="${pref.name||''}"/>
      <select data-f="slot" style="max-width:140px"><option>Body</option><option>Head</option><option>Shield</option><option>Misc</option></select>
      <input data-f="bonus" type="number" inputmode="numeric" placeholder="Bonus" style="max-width:120px" value="${pref.bonus||0}"/>
      <label class="inline" style="gap:6px"><input type="checkbox" data-f="equipped" ${pref.equipped?'checked':''}/> Equipped</label>
    </div>
    <div class="inline"><button class="btn-sm" data-act="del">Delete</button></div>`;
  d.querySelector('[data-f="slot"]').value = pref.slot || 'Body';
  d.querySelectorAll('input,select').forEach(el=> el.addEventListener('input', updateDerived));
  d.querySelector('[data-act="del"]').addEventListener('click', ()=>{ d.remove(); updateDerived(); });
  return d;}
function cardItem(pref={}){ const d=document.createElement('div'); d.className='card'; d.dataset.kind='item';
  d.innerHTML=`<div class="inline">
      <input data-f="name" placeholder="Name" value="${pref.name||''}"/>
      <input data-f="qty" type="number" inputmode="numeric" placeholder="Qty" style="max-width:100px" value="${pref.qty||1}"/>
      <input data-f="notes" placeholder="Notes" value="${pref.notes||''}"/>
    </div>
    <div class="inline"><button class="btn-sm" data-act="del">Delete</button></div>`;
  d.querySelector('[data-act="del"]').addEventListener('click', ()=> d.remove());
  return d;}
$('add-weapon').addEventListener('click', ()=> $('weapons').appendChild(cardWeapon()));
$('add-armor').addEventListener('click', ()=> $('armors').appendChild(cardArmor()));
$('add-item').addEventListener('click', ()=> $('items').appendChild(cardItem()));

/* ========= Gear Catalog (seeded; extend as needed) ========= */
const CATALOG = (()=>{ const mk=(style,type,rarity,name,tc,notes)=>({style,type,rarity,name,tc,notes}); const out=[];
  out.push(
    mk('Universal','Armor','Common','Tactical Mesh Undersuit','+1 TC','Lightweight, breathable'),
    mk('Universal','Armor','Uncommon','Guardian Field Plate','+2 TC','+1 to STR or DEX saves'),
    mk('Universal','Armor','Rare','Reflex-Reinforced Vest','+3 TC','Advantage vs knocked prone'),
    mk('Universal','Armor','Elite','Deflection Halo Exosuit','+3 TC','First hit each encounter reduced by 5'),
    mk('Universal','Armor','Legendary','Aegis Core Cuirass','+4 TC','Auto-block one physical hit per session'),
    mk('Universal','Shield','Common','Polysteel Riot Plate','+1 TC vs melee',''),
    mk('Universal','Shield','Uncommon','Echo-Deflector Disk','+2 TC vs ranged',''),
    mk('Universal','Shield','Rare','Quantum-Stitch Bracer','+2 TC','Phase through one AoE per combat'),
    mk('Universal','Shield','Elite','Mirror Field Buckler','+3 TC','Reflect one ranged hit per encounter'),
    mk('Universal','Shield','Legendary','Nova Dome Projector','+2 TC to allies (10ft) 1/day',''),
    mk('Universal','Utility','Common','Combat Reflex Enhancer','+1 TC (first round)',''),
    mk('Universal','Utility','Uncommon','Adrenaline Booster Patch','+2 TC under 1/2 HP',''),
    mk('Universal','Utility','Rare','Perception Sync Visor','+1 TC & +1 Passive Perception',''),
    mk('Universal','Utility','Elite','Aegis Burst Pack','+3 TC for 1 turn (1/short rest)',''),
    mk('Universal','Utility','Legendary','Null Pulse Core','+2 TC to allies (5ft)','Emit protective wave')
  );
  out.push(
    mk('Physical Powerhouse','Armor','Common','Combat Vest MK-I','+1 TC','Reinforced plating'),
    mk('Physical Powerhouse','Armor','Uncommon','Shockframe Bodysuit','+2 TC','+1 STR saves'),
    mk('Physical Powerhouse','Armor','Rare','Tectonic Armor Rig','+3 TC','Immune to knockback'),
    mk('Physical Powerhouse','Shield','Common','Bunker Bracer','+1 TC vs melee',''),
    mk('Physical Powerhouse','Utility','Uncommon','Momentum Harness','+2 TC if immobile','')
  );
  out.push(
    mk('Energy Manipulator','Armor','Uncommon','Livewire Vest','+2 TC vs energy',''),
    mk('Energy Manipulator','Armor','Legendary','Stormcell Frame','+3 TC','Gain 1 SP when hit'),
    mk('Energy Manipulator','Shield','Uncommon','Plasma Flicker Disk','+2 TC vs ranged powers',''),
    mk('Energy Manipulator','Utility','Rare','Amplifier Ring','+2 TC after 4+ SP power','')
  );
  out.push(
    mk('Speedster','Armor','Common','Aerodynamic Skinsuit','+1 TC, +10 ft move',''),
    mk('Speedster','Armor','Elite','Reactive Velocity Mesh','+2 TC','+2 Initiative'),
    mk('Speedster','Shield','Common','Momentum Redirector','+2 TC if moved 10+ ft',''),
    mk('Speedster','Utility','Uncommon','Stutter-Blink Harness','+1 TC','Teleport 5 ft as reaction (1/combat)')
  );
  out.push(
    mk('Telekinetic/Psychic','Armor','Uncommon','Psionic Feedback Mesh','+2 TC','Attacker takes 1 psychic on miss'),
    mk('Telekinetic/Psychic','Shield','Common','Mind Ward Halo','+2 TC vs mental',''),
    mk('Telekinetic/Psychic','Utility','Common','Telekinetic Aegis','+2 TC (spend 1 SP, 1 round)','')
  );
  out.push(
    mk('Illusionist','Armor','Common','Refraction Cloak','+2 TC vs first attack each round',''),
    mk('Illusionist','Shield','Elite','Shadowlight Barrier','+2 TC','Redirect one ranged attack per combat'),
    mk('Illusionist','Utility','Rare','Vanishing Step Locket','â€”','Become invisible as reaction')
  );
  out.push(
    mk('Shape-shifter','Armor','Elite','Phaseform Hide','+3 TC','Enter semi-liquid state'),
    mk('Shape-shifter','Shield','Legendary','Shifting Scale Dome','+3 TC','Attacker â€“2 to hit next round'),
    mk('Shape-shifter','Utility','Elite','Shedskin Matrix','+3 TC','Leave decoy clone')
  );
  out.push(
    mk('Elemental Controller','Armor','Elite','Stoneguard Core','+3 TC','Immunity to knockdown'),
    mk('Elemental Controller','Shield','Elite','Galehalo Barrier','+3 TC vs ranged','Deflect projectiles'),
    mk('Elemental Controller','Utility','Elite','Cyclone Core Belt','â€”','Immune to AoE for 1 turn (1 SP)')
  );
  return out;})();

const styles = ['Universal','Physical Powerhouse','Energy Manipulator','Speedster','Telekinetic/Psychic','Illusionist','Shape-shifter','Elemental Controller'];
const styleSel = $('catalog-filter-style'); styles.forEach(s=> styleSel.add(new Option(s,s))); styleSel.value='Universal';
function renderCatalog(){
  const s = $('catalog-search').value.toLowerCase().trim();
  const style = styleSel.value, type=$('catalog-filter-type').value, rar=$('catalog-filter-rarity').value;
  const rows = CATALOG.filter(g => (!style || g.style===style) && (!type || g.type===type) && (!rar || g.rarity===rar) &&
    (!s || (g.name.toLowerCase().includes(s) || g.notes.toLowerCase().includes(s))));
  $('catalog-list').innerHTML = rows.map((g,i)=>`
    <div class="catalog-item">
      <div class="pill">${g.rarity}</div>
      <div><b>${g.name}</b> <span class="small">â€” ${g.type} â€” ${g.tc}${g.notes?` â€” ${g.notes}`:''}</span></div>
      <div><button class="btn-sm" data-add="${i}">Add</button></div>
    </div>`).join('');
  qsa('[data-add]').forEach(btn => btn.addEventListener('click', ()=>{
    const it = rows[Number(btn.dataset.add)];
    if (it.type==='Armor' || it.type==='Shield'){
      const slot = it.type==='Shield' ? 'Shield' : 'Body';
      $('armors').appendChild(cardArmor({name:it.name, slot, bonus: Number((it.tc.match(/\+(\d+)/)||[,0])[1]), equipped:true}));
    } else {
      $('items').appendChild(cardItem({name:it.name, notes:`${it.rarity} â€” ${it.tc}${it.notes?(' â€” '+it.notes):''}`}));
    }
    updateDerived(); toast('Added to sheet');
  }));
}
$('open-catalog').addEventListener('click', ()=>{ renderCatalog(); show('modal-catalog'); });
['catalog-filter-style','catalog-filter-type','catalog-filter-rarity','catalog-search'].forEach(id=> $(id).addEventListener('input', renderCatalog));

/* ========= Encounter / Initiative ========= */
let round = Number(localStorage.getItem('enc-round')||'1')||1;
const roster = JSON.parse(localStorage.getItem('enc-roster')||'[]');
function saveEnc(){ localStorage.setItem('enc-roster', JSON.stringify(roster)); localStorage.setItem('enc-round', String(round)); }
function renderEnc(){
  $('round-pill').textContent='Round '+round;
  const list=$('enc-list'); list.innerHTML='';
  roster.sort((a,b)=>(b.init||0)-(a.init||0) || String(a.name).localeCompare(String(b.name)));
  roster.forEach((r,idx)=>{
    const row=document.createElement('div'); row.className='catalog-item';
    row.innerHTML = `<div class="pill">${r.init}</div><div><b>${r.name}</b></div>
      <div class="inline" style="gap:6px">
        <button class="btn-sm" data-up="${idx}">â–²</button>
        <button class="btn-sm" data-down="${idx}">â–¼</button>
        <button class="btn-sm" data-del="${idx}">Delete</button>
      </div>`;
    list.appendChild(row);
  });
  qsa('[data-del]', $('enc-list')).forEach(b=> b.addEventListener('click', ()=>{ roster.splice(Number(b.dataset.del),1); renderEnc(); saveEnc(); }));
  qsa('[data-up]', $('enc-list')).forEach(b=> b.addEventListener('click', ()=>{ const i=Number(b.dataset.up); if(i>0){ const t=roster[i-1]; roster[i-1]=roster[i]; roster[i]=t; renderEnc(); saveEnc(); }}));
  qsa('[data-down]', $('enc-list')).forEach(b=> b.addEventListener('click', ()=>{ const i=Number(b.dataset.down); if(i<roster.length-1){ const t=roster[i+1]; roster[i+1]=roster[i]; roster[i]=t; renderEnc(); saveEnc(); }}));
}
$('btn-enc').addEventListener('click', ()=>{ renderEnc(); show('modal-enc'); });
$('enc-add').addEventListener('click', ()=>{ const name=$('enc-name').value.trim(); const init=Number($('enc-init').value||0);
  if(!name) return alert('Enter a name'); roster.push({name, init}); $('enc-name').value=''; $('enc-init').value=''; renderEnc(); saveEnc(); });
$('enc-next').addEventListener('click', ()=>{ round+=1; renderEnc(); saveEnc(); });
$('enc-reset').addEventListener('click', ()=>{ if(!confirm('Reset encounter and round?')) return; round=1; roster.length=0; renderEnc(); saveEnc(); });
qsa('#modal-enc [data-close]').forEach(b=> b.addEventListener('click', ()=> hide('modal-enc')));

/* ========= Save / Load (cloud-first, silent local mirror) ========= */
async function getRTDB(){
  const cfgEl = $('firebase-config'); if(!cfgEl) return null;
  let cfg=null; try{ cfg=JSON.parse(cfgEl.textContent) }catch(e){}
  if (!cfg || !cfg.apiKey || !cfg.databaseURL) return null;
  const [{ initializeApp }, { getAuth, signInAnonymously, onAuthStateChanged }, { getDatabase, ref, get, set }] = await Promise.all([
    import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js'),
    import('https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js'),
    import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js')
  ]);
  let app; try{ app = window.firebaseApp || initializeApp(cfg); window.firebaseApp = app; } catch(e){ app = window.firebaseApp; }
  const auth = getAuth(app);
  await new Promise(res => onAuthStateChanged(auth, ()=>res(), ()=>res()));
  if(!auth.currentUser){ try{ await signInAnonymously(auth) }catch(e){} }
  const db=getDatabase(app);
  return { db, ref, get, set };
}
function serialize(){
  const data={};
  qsa('input,select,textarea').forEach(el=>{
    const id = el.id; if (!id) return;
    if (el.type==='checkbox') data[id] = !!el.checked; else data[id] = el.value;
  });
  data.powers = qsa("[data-kind='power']").map(card => ({
    name: qs("[data-f='name']", card)?.value || '',
    sp: qs("[data-f='sp']", card)?.value || '',
    save: qs("[data-f='save']", card)?.value || '',
    range: qs("[data-f='range']", card)?.value || '',
    effect: qs("[data-f='effect']", card)?.value || ''
  }));
  data.signatures = qsa("[data-kind='sig']").map(card => ({
    name: qs("[data-f='name']", card)?.value || '',
    sp: qs("[data-f='sp']", card)?.value || '',
    save: qs("[data-f='save']", card)?.value || '',
    special: qs("[data-f='special']", card)?.value || '',
    desc: qs("[data-f='desc']", card)?.value || ''
  }));
  data.weapons = qsa("[data-kind='weapon']").map(card => ({
    name: qs("[data-f='name']", card)?.value || '',
    damage: qs("[data-f='damage']", card)?.value || '',
    range: qs("[data-f='range']", card)?.value || ''
  }));
  data.armor = qsa("[data-kind='armor']").map(card => ({
    name: qs("[data-f='name']", card)?.value || '',
    slot: qs("[data-f='slot']", card)?.value || 'Body',
    bonus: Number(qs("[data-f='bonus']", card)?.value || 0),
    equipped: !!qs("[data-f='equipped']", card)?.checked
  }));
  data.items = qsa("[data-kind='item']").map(card => ({
    name: qs("[data-f='name']", card)?.value || '',
    qty: Number(qs("[data-f='qty']", card)?.value || 1),
    notes: qs("[data-f='notes']", card)?.value || ''
  }));
  return data;
}
function deserialize(data){
  $('powers').innerHTML=''; $('sigs').innerHTML=''; $('weapons').innerHTML=''; $('armors').innerHTML=''; $('items').innerHTML='';
  Object.entries(data||{}).forEach(([k,v])=>{ const el=$(k); if (!el) return; if (el.type==='checkbox') el.checked=!!v; else el.value=v; });
  (data?.powers||[]).forEach(p=> $('powers').appendChild(cardPower(p)));
  (data?.signatures||[]).forEach(s=> $('sigs').appendChild(cardSig(s)));
  (data?.weapons||[]).forEach(w=> $('weapons').appendChild(cardWeapon(w)));
  (data?.armor||[]).forEach(a=> $('armors').appendChild(cardArmor(a)));
  (data?.items||[]).forEach(i=> $('items').appendChild(cardItem(i)));
  updateDerived();
}
const ENCODE = (s)=>encodeURIComponent(String(s||''));
async function saveCloud(name, payload){
  const r = await getRTDB().catch(()=>null);
  if (r){ const { db, ref, set } = r; await set(ref(db, '/saves/'+ENCODE(name)), { updatedAt: Date.now(), data: payload }); }
  try{ localStorage.setItem('save:'+name, JSON.stringify(payload)); localStorage.setItem('last-save', name);}catch(e){}
}
async function loadCloud(name){
  const r = await getRTDB().catch(()=>null);
  if (r){
    const { db, ref, get } = r;
    let snap = await get(ref(db, '/saves/'+ENCODE(name)));
    if (!snap.exists()) snap = await get(ref(db, '/saves/'+name));
    if (snap.exists()){
      const v = snap.val();
      return v?.data || v?.character || v?.sheet || v;
    }
  }
  try{ const raw=localStorage.getItem('save:'+name); if(raw) return JSON.parse(raw); }catch(e){}
  throw new Error('No save found');
}
$('btn-save').addEventListener('click', ()=>{ $('save-key').value = localStorage.getItem('last-save') || $('superhero').value || ''; show('modal-save'); });
$('btn-load').addEventListener('click', ()=>{ $('load-key').value = ''; show('modal-load'); });
$('do-save').addEventListener('click', async ()=>{
  const name = $('save-key').value.trim(); if(!name) return alert('Enter a name');
  await saveCloud(name, serialize()); hide('modal-save'); toast('Saved');
});
$('do-load').addEventListener('click', async ()=>{
  const name = $('load-key').value.trim(); if(!name) return alert('Enter a name');
  try{ const data = await loadCloud(name); deserialize(data); hide('modal-load'); toast('Loaded'); } catch(e){ alert('Could not load: '+(e?.message||'')); }
});

/* ========= Rules ========= */
$('btn-rules').addEventListener('click', ()=> show('modal-rules'));

/* ========= Close + click-outside ========= */
$('btn-log').addEventListener('click', ()=> show('modal-log'));
qsa('.overlay').forEach(ov=> ov.addEventListener('click', (e)=>{ if (e.target===ov) ov.classList.add('hidden'); }));

/* ========= boot ========= */
updateDerived();
</script>
</body>
</html>
