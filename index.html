<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<meta name="description" content="Mobile-optimized character tracker for the Catalyst Core RPG."/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link rel="icon" href="images/Logo.png" type="image/png"/>
<meta name="theme-color" content="#0e1117"/>
<meta name="color-scheme" content="dark light"/>
<title>Catalyst Core</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="styles/main.css"/>
</head>
<body>
<noscript>This app requires JavaScript to run properly.</noscript>

<a href="#main" class="skip-link">Skip to main content</a>


<header>
  <nav class="tabs" role="tablist" aria-label="Primary">
    <button id="btn-theme" class="icon" aria-label="Toggle Theme" type="button">
      <svg id="icon-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"/>
      </svg>
      <svg id="icon-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"/>
      </svg>
      <svg id="icon-high" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <circle cx="12" cy="12" r="9"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18"/>
      </svg>
      <svg id="icon-forest" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17 14 20 17.3a1 1 0 0 1-.7 1.7H4.7a1 1 0 0 1-.7-1.7L7 14h-.3a1 1 0 0 1-.7-1.7L9 9h-.2A1 1 0 0 1 8 7.3L12 3l4 4.3a1 1 0 0 1-.8 1.7H15l3 3.3a1 1 0 0 1-.7 1.7H17Z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 22v-3"/>
      </svg>
      <svg id="icon-ocean" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
      </svg>
      <svg id="icon-mutant" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 0 1-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 0 1 4.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0 1 12 15a9.065 9.065 0 0 0-6.23-.693L5 14.5m14.8.8 1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0 1 12 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/>
      </svg>
      <svg id="icon-enhanced" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"/>
      </svg>
      <svg id="icon-magic" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z"/>
      </svg>
      <svg id="icon-alien" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/>
      </svg>
      <svg id="icon-mystic" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" style="display:none">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
      </svg>
    </button>
    <button class="tab active" data-go="combat" aria-label="Combat" title="Combat" role="tab" aria-current="page" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <polyline stroke-linecap="round" stroke-linejoin="round" points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/>
        <line stroke-linecap="round" stroke-linejoin="round" x1="13" y1="19" x2="19" y2="13"/>
        <line stroke-linecap="round" stroke-linejoin="round" x1="16" y1="16" x2="20" y2="20"/>
        <line stroke-linecap="round" stroke-linejoin="round" x1="19" y1="21" x2="21" y2="19"/>
      </svg>
    </button>
    <button class="tab" data-go="abilities" aria-label="Abilities" title="Abilities" role="tab" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.8132 15.9038L9 18.75L8.1868 15.9038C7.75968 14.4089 6.59112 13.2403 5.09619 12.8132L2.25 12L5.09619 11.1868C6.59113 10.7597 7.75968 9.59112 8.1868 8.09619L9 5.25L9.8132 8.09619C10.2403 9.59113 11.4089 10.7597 12.9038 11.1868L15.75 12L12.9038 12.8132C11.4089 13.2403 10.2403 14.4089 9.8132 15.9038Z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M18.2589 8.71454L18 9.75L17.7411 8.71454C17.4388 7.50533 16.4947 6.56117 15.2855 6.25887L14.25 6L15.2855 5.74113C16.4947 5.43883 17.4388 4.49467 17.7411 3.28546L18 2.25L18.2589 3.28546C18.5612 4.49467 19.5053 5.43883 20.7145 5.74113L21.75 6L20.7145 6.25887C19.5053 6.56117 18.5612 7.50533 18.2589 8.71454Z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.8942 20.5673L16.5 21.75L16.1058 20.5673C15.8818 19.8954 15.3546 19.3682 14.6827 19.1442L13.5 18.75L14.6827 18.3558C15.3546 18.1318 15.8818 17.6046 16.1058 16.9327L16.5 15.75L16.8942 16.9327C17.1182 17.6046 17.6454 18.1318 18.3173 18.3558L19.5 18.75L18.3173 19.1442C17.6454 19.3682 17.1182 19.8954 16.8942 20.5673Z"/>
      </svg>
    </button>
    <button class="tab" data-go="powers" aria-label="Powers" title="Powers" role="tab" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5L14.25 2.25L12 10.5H20.25L9.75 21.75L12 13.5H3.75Z"/>
      </svg>
    </button>
    <button class="tab" data-go="gear" aria-label="Gear" title="Gear" role="tab" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>
      </svg>
    </button>
    <button class="tab" data-go="story" aria-label="Story" title="Story" role="tab" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.04168C10.4077 4.61656 8.30506 3.75 6 3.75C4.94809 3.75 3.93834 3.93046 3 4.26212V18.5121C3.93834 18.1805 4.94809 18 6 18C8.30506 18 10.4077 18.8666 12 20.2917M12 6.04168C13.5923 4.61656 15.6949 3.75 18 3.75C19.0519 3.75 20.0617 3.93046 21 4.26212V18.5121C20.0617 18.1805 19.0519 18 18 18C15.6949 18 13.5923 18.8666 12 20.2917M12 6.04168V20.2917"/>
      </svg>
    </button>
      <span class="tabs-title">Catalyst Core</span>
    <div class="dropdown">
      <button id="btn-menu" class="icon" aria-label="Menu" title="Menu" aria-haspopup="true" aria-expanded="false" aria-controls="menu-actions" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6.75h15m-15 5.25h15m-15 5.25h15"/>
        </svg>
      </button>
      <div id="menu-actions" class="menu" hidden>
        <button id="btn-player" class="btn-sm">Log In</button>
        <button id="btn-wizard" class="btn-sm" aria-label="Character creation wizard" title="Character creation wizard">Character wizard</button>
        <button id="btn-enc" class="btn-sm" aria-label="Encounter / Initiative" title="Encounter / Initiative">Encounter / Initiative</button>
        <button id="btn-save" class="btn-sm">Save</button>
        <button id="btn-log" class="btn-sm">Roll/Flip Log</button>
        <button id="btn-campaign" class="btn-sm">Campaign Log</button>
        <button id="btn-rules" class="btn-sm">Rules</button>
        <button id="btn-help" class="btn-sm">Help</button>
        <button id="btn-ai" class="btn-sm">CC A.I.</button>
        <button id="btn-dm" class="btn-sm" hidden>Players</button>
      </div>
    </div>
  </nav>
</header>

<main id="main">
  <!-- COMBAT -->
  <fieldset data-tab="combat" class="card">
    <div class="grid grid-2 roll-flip-grid">
      <fieldset class="card">
        <legend>Dice Roll</legend>
        <div class="inline">
          <label for="dice-sides" class="sr-only">Sides</label>
          <select id="dice-sides">
            <option value="4">d4</option><option value="6">d6</option><option value="8">d8</option><option value="10">d10</option><option value="12">d12</option><option value="20" selected>d20</option><option value="100">d100</option>
          </select>
          <label for="dice-count" class="sr-only">Count</label>
          <input id="dice-count" type="number" inputmode="numeric" min="1" value="1"/>
          <button id="roll-dice" class="btn-sm">Roll</button>
        </div>
        <span class="pill result" id="dice-out" data-placeholder="000"></span>
      </fieldset>
      <fieldset class="card">
        <legend>Coin Flip</legend>
        <div class="inline">
          <button id="flip" class="btn-sm">Flip</button>
        </div>
        <span class="pill result" id="flip-out" data-placeholder="Heads"></span>
      </fieldset>
    </div>
    <fieldset class="card">
      <legend>Death Saves</legend>
      <div class="death-saves">
        <label for="death-save-1" class="sr-only">Death Save 1</label>
        <input type="checkbox" id="death-save-1"/>
        <label for="death-save-2" class="sr-only">Death Save 2</label>
        <input type="checkbox" id="death-save-2"/>
        <label for="death-save-3" class="sr-only">Death Save 3</label>
        <input type="checkbox" id="death-save-3"/>
      </div>
    </fieldset>
    <fieldset class="card">
      <legend>Cinematic Action Point</legend>
      <label class="inline" for="cap-check"><input type="checkbox" id="cap-check"/> <span id="cap-status">Available</span></label>
      <p>A Cinematic Action Point lets a hero perform an extraordinary, story-driven action. Check the box when one is available and uncheck it once spent.</p>
    </fieldset>
  </fieldset>

  <fieldset data-tab="combat" class="card">
    <div class="grid grid-2">
      <fieldset class="card">
        <legend>HP</legend>
        <div class="inline">
          <progress id="hp-bar" max="30" value="30" style="width:100%"></progress>
          <span class="pill" id="hp-pill">30/30</span>
        </div>
        <div class="inline">
          <input id="hp-roll" type="hidden" value="0"/>
          <button id="hp-roll-add" class="btn-sm" type="button">Add Tier HP</button>
        </div>
        <div class="inline">
          <label for="hp-temp" class="sr-only">Temp HP</label>
          <input id="hp-temp" type="number" inputmode="numeric" placeholder="Temp HP"/>
          <label for="hp-amt" class="sr-only">Amount</label>
          <input id="hp-amt" type="number" inputmode="numeric" placeholder="Amount"/>
          <button id="hp-dmg" class="btn-sm">Damage</button>
          <button id="hp-heal" class="btn-sm">Heal</button>
          <button id="hp-full" class="btn-sm">Reset HP</button>
        </div>
      </fieldset>
      <fieldset class="card">
        <legend>SP</legend>
        <div class="inline">
          <progress id="sp-bar" max="5" value="5" style="width:100%"></progress>
          <span class="pill" id="sp-pill">5/5</span>
        </div>
        <div class="inline">
          <label for="sp-temp" class="sr-only">Temp SP</label>
          <input id="sp-temp" type="number" inputmode="numeric" placeholder="Temp SP"/>
          <div class="sp-grid">
            <button class="btn-sm" data-sp="-1">-1 SP</button>
            <button class="btn-sm" data-sp="-2">-2 SP</button>
            <button class="btn-sm" data-sp="-3">-3 SP</button>
            <button class="btn-sm" data-sp="-4">-4 SP</button>
          </div>
          <button class="btn-sm" data-sp="-5">-5 SP</button>
          <button id="sp-full" class="btn-sm">Reset SP</button>
        </div>
        <div class="inline"><button id="long-rest" class="btn-sm">Long Rest</button></div>
      </fieldset>
    </div>

    <div class="grid grid-2">
      <fieldset class="card">
        <legend>Initiative &amp; Speed</legend>
        <label for="initiative">Initiative</label>
        <input id="initiative" type="number" inputmode="numeric" placeholder="auto from DEX + bonuses" readonly/>
        <label for="speed">Speed (ft)</label>
        <input id="speed" type="number" inputmode="numeric" placeholder="30"/>
      </fieldset>
      <fieldset class="card">
        <legend>Defense Stats</legend>
        <label for="pp">Passive Perception</label>
        <input id="pp" type="number" readonly/>
        <label for="armor-bonus">Armor/Shield Bonus (auto)</label>
        <input id="armor-bonus" type="number" readonly/>
        <label for="origin-bonus">Power/Origin Bonus</label>
        <input id="origin-bonus" type="number" inputmode="numeric" value="0"/>
        <label for="tc">TC</label>
        <input id="tc" type="number" readonly/>
      </fieldset>
    </div>
  </fieldset>

  <fieldset data-tab="combat" class="card">
    <h2 class="card-title">Status Effects</h2>
    <div id="statuses" class="grid grid-2"></div>
  </fieldset>

  <!-- ABILITIES -->
  <fieldset data-tab="abilities" class="card">
    <h2 class="card-title">Ability Scores</h2>
    <div id="abil-grid" class="grid ability-grid"></div>
    <fieldset class="card">
      <legend>Proficiency &amp; Power</legend>
      <div class="inline">
        <div style="flex:1">
          <label for="prof-bonus">Proficiency Bonus</label>
          <input id="prof-bonus" type="number" inputmode="numeric" value="2"/>
        </div>
        <div style="flex:1">
          <label for="power-save-ability">Power Save Ability</label>
          <select id="power-save-ability">
            <option value="str">STR</option><option value="dex">DEX</option><option value="con">CON</option>
            <option value="int">INT</option><option value="wis" selected>WIS</option><option value="cha">CHA</option>
          </select>
        </div>
        <div style="flex:1">
          <label for="power-save-dc">Power Save DC</label>
          <input id="power-save-dc" type="number" readonly/>
        </div>
      </div>
    </fieldset>
    <fieldset class="card">
      <legend>Saving Throws</legend>
      <div id="saves" class="grid ability-grid"></div>
    </fieldset>
    <fieldset class="card">
      <legend>Skills</legend>
      <div id="skills" class="grid ability-grid"></div>
    </fieldset>
  </fieldset>

  <!-- POWERS -->
  <fieldset data-tab="powers" class="card">
    <h2 class="card-title">Powers</h2>
    <div class="inline" style="justify-content:flex-end">
      <button id="add-power" style="max-width:180px">Add Power</button>
    </div>
    <div class="grid grid-2" id="powers"></div>

    <div class="inline" style="justify-content:space-between;margin-top:8px">
      <h3 style="margin:0">Signature Moves</h3>
      <button id="add-sig" style="max-width:200px">Add Signature Move</button>
    </div>
    <div class="grid grid-2" id="sigs"></div>
  </fieldset>

  <!-- GEAR -->
  <fieldset data-tab="gear" class="card">
    <h2 class="card-title">Gear</h2>
    <div class="grid grid-2">
      <div class="card">
        <div class="inline" style="justify-content:space-between">
          <h3 style="margin:0">Weapons</h3><button id="add-weapon" class="btn-sm" style="max-width:140px">Add Weapon</button>
        </div>
        <div id="weapons" class="grid grid-1"></div>
      </div>
      <div class="card">
        <div class="inline" style="justify-content:space-between">
          <h3 style="margin:0">Armor &amp; Protection</h3><button id="add-armor" class="btn-sm" style="max-width:160px">Add Armor</button>
        </div>
        <div id="armors" class="grid grid-1"></div>
      </div>
      <div class="card" style="grid-column:1/-1">
        <div class="inline" style="justify-content:space-between">
          <h3 style="margin:0">Gear &amp; Items</h3>
          <div class="inline">
            <button id="add-item" class="btn-sm" style="max-width:140px">Add Item</button>
            <button id="open-catalog" class="btn-sm" style="max-width:160px">Open Gear Catalog</button>
          </div>
        </div>
        <div id="items" class="grid grid-1"></div>
      </div>
    </div>
  </fieldset>

  <!-- STORY -->
  <fieldset data-tab="story" class="card">
    <h2 class="card-title">Character & Story</h2>
    <div class="grid grid-2">
      <div class="card"><label for="superhero">Superhero Identity</label><input id="superhero" placeholder="Vigilante Name"/></div>
      <div class="card"><label for="secret">Secret Identity</label><input id="secret" placeholder="Real name"/></div>
      <div class="card">
        <label for="publicIdentity">Public Identity</label>
        <select id="publicIdentity"><option value="Public">Public</option><option value="Secret" selected>Secret</option></select>
      </div>
      <div class="card">
        <label for="tier">Tier</label>
        <input id="tier" type="text" readonly/>
      </div>
      <div class="card" style="grid-column:1/-1">
        <label for="xp">Experience</label>
        <div class="inline">
          <input id="xp" type="number" inputmode="numeric" value="0" min="0" style="max-width:120px" readonly/>
          <progress id="xp-bar" max="2000" value="0" style="flex:1"></progress>
          <span id="xp-pill" class="pill">0/2000</span>
        </div>
        <div class="inline">
          <label for="xp-amt" class="sr-only">Amount</label>
          <input id="xp-amt" type="number" inputmode="numeric" placeholder="Amount"/>
          <select id="xp-mode" style="max-width:160px">
            <option value="add">Add XP</option>
            <option value="remove">Remove XP</option>
          </select>
          <button id="xp-submit" class="btn-sm">Submit</button>
        </div>
      </div>
      <div class="card">
        <label for="alignment">Alignment</label>
        <select id="alignment">
          <option value="">Select one</option>
          <option>Paragon (Lawful Light)</option>
          <option>Guardian (Neutral Light)</option>
          <option>Vigilante (Chaotic Light)</option>
          <option>Sentinel (Lawful Neutral)</option>
          <option>Outsider (True Neutral)</option>
          <option>Wildcard (Chaotic Neutral)</option>
          <option>Inquisitor (Lawful Shadow)</option>
          <option>Anti-Hero (Neutral Shadow)</option>
          <option>Renegade (Chaotic Shadow)</option>
        </select>
        <ul id="alignment-perks" class="perk-list"></ul>
      </div>
      <div class="card">
        <label for="classification">Classification</label>
        <select id="classification">
          <option value="">Select one</option><option>Mutant</option><option>Enhanced Human</option><option>Magic User</option><option>Alien/Extraterrestrial</option><option>Mystical Being</option>
        </select>
        <ul id="classification-perks" class="perk-list"></ul>
      </div>
      <div class="card">
        <label for="power-style">Primary Power Style</label>
        <select id="power-style">
          <option value="">Select one</option><option>Physical Powerhouse</option><option>Energy Manipulator</option><option>Speedster</option>
          <option>Telekinetic/Psychic</option><option>Illusionist</option><option>Shape-shifter</option><option>Elemental Controller</option>
        </select>
        <ul id="power-style-perks" class="perk-list"></ul>
      </div>
      <div class="card">
        <label for="power-style-2">Secondary Power Style</label>
        <select id="power-style-2">
          <option value="">Select one</option>
          <option>None</option>
          <option>Physical Powerhouse</option><option>Energy Manipulator</option><option>Speedster</option>
          <option>Telekinetic/Psychic</option><option>Illusionist</option><option>Shape-shifter</option><option>Elemental Controller</option>
        </select>
      </div>
      <div class="card">
        <label for="origin">Origin Story</label>
        <select id="origin">
          <option value="">Select one</option>
          <option>The Accident</option>
          <option>The Experiment</option>
          <option>The Legacy</option>
          <option>The Awakening</option>
          <option>The Pact</option>
          <option>The Lost Time</option>
          <option>The Exposure</option>
          <option>The Rebirth</option>
          <option>The Vigil</option>
          <option>The Redemption</option>
        </select>
        <ul id="origin-perks" class="perk-list"></ul>
      </div>
      <div class="card">
        <label>Faction Reputation</label>
          <div class="grid grid-1 faction-rep">
            <div>
              <div class="inline faction-header">
                <span class="pill pill-sm">O.M.N.I.</span>
                <span id="omni-rep-tier" class="pill pill-sm">Neutral</span>
              </div>
              <progress id="omni-rep-bar" max="100" value="0"></progress>
              <p id="omni-rep-perk" class="perk"></p>
              <div class="inline">
                <button id="omni-rep-gain" class="btn-sm">Gain</button>
                <button id="omni-rep-lose" class="btn-sm">Lose</button>
              </div>
              <input type="hidden" id="omni-rep" value="200"/>
            </div>
            <div>
              <div class="inline faction-header">
                <span class="pill pill-sm">P.F.V.</span>
                <span id="pfv-rep-tier" class="pill pill-sm">Neutral</span>
              </div>
              <progress id="pfv-rep-bar" max="100" value="0"></progress>
              <p id="pfv-rep-perk" class="perk"></p>
              <div class="inline">
                <button id="pfv-rep-gain" class="btn-sm">Gain</button>
                <button id="pfv-rep-lose" class="btn-sm">Lose</button>
              </div>
              <input type="hidden" id="pfv-rep" value="200"/>
            </div>
            <div>
              <div class="inline faction-header">
                <span class="pill pill-sm">Cosmic Conclave</span>
                <span id="conclave-rep-tier" class="pill pill-sm">Neutral</span>
              </div>
              <progress id="conclave-rep-bar" max="100" value="0"></progress>
              <p id="conclave-rep-perk" class="perk"></p>
              <div class="inline">
                <button id="conclave-rep-gain" class="btn-sm">Gain</button>
                <button id="conclave-rep-lose" class="btn-sm">Lose</button>
              </div>
              <input type="hidden" id="conclave-rep" value="200"/>
            </div>
            <div>
              <div class="inline faction-header">
                <span class="pill pill-sm">Greyline PMC</span>
                <span id="greyline-rep-tier" class="pill pill-sm">Neutral</span>
              </div>
              <progress id="greyline-rep-bar" max="100" value="0"></progress>
              <p id="greyline-rep-perk" class="perk"></p>
              <div class="inline">
                <button id="greyline-rep-gain" class="btn-sm">Gain</button>
                <button id="greyline-rep-lose" class="btn-sm">Lose</button>
              </div>
              <input type="hidden" id="greyline-rep" value="200"/>
            </div>
          </div>
      </div>

    </div>

    <div class="card">
      <label for="story-notes">Backstory / Notes</label>
      <textarea id="story-notes" rows="6" placeholder="Key events, allies, vulnerabilities, research/training notes, etc."></textarea>
    </div>
      <h3>Character Questions</h3>
    <div class="grid grid-1">
      <div class="card"><label for="q-mask">Who are you behind the mask?</label><textarea id="q-mask" rows="2"></textarea></div>
      <div class="card"><label for="q-justice">What does justice mean to you?</label><textarea id="q-justice" rows="2"></textarea></div>
      <div class="card"><label for="q-fear">What is your biggest fear or unresolved trauma?</label><textarea id="q-fear" rows="2"></textarea></div>
      <div class="card"><label for="q-first-power">What moment first defined your sense of power—was it thrilling, terrifying, or tragic?</label><textarea id="q-first-power" rows="2"></textarea></div>
      <div class="card"><label for="q-origin-meaning">What does your Origin Story mean to you now?</label><textarea id="q-origin-meaning" rows="2"></textarea></div>
      <div class="card"><label for="q-before-powers">What was your life like before you had powers or before you remembered having them?</label><textarea id="q-before-powers" rows="2"></textarea></div>
      <div class="card"><label for="q-power-scare">What is one way your powers scare even you?</label><textarea id="q-power-scare" rows="2"></textarea></div>
      <div class="card"><label for="q-signature-move">What is your signature move or ability, and how does it reflect who you are?</label><textarea id="q-signature-move" rows="2"></textarea></div>
      <div class="card"><label for="q-emotional">What happens to your powers when you are emotionally compromised?</label><textarea id="q-emotional" rows="2"></textarea></div>
      <div class="card"><label for="q-no-line">What line will you never cross even if the world burns around you?</label><textarea id="q-no-line" rows="2"></textarea></div>
      <div class="card"><label for="q-alignment-fear">Which Alignment do you identify with, and which do you fear becoming?</label><textarea id="q-alignment-fear" rows="2"></textarea></div>
      <div class="card"><label for="q-opinion">Whose opinion matters more to you—civilians, teammates, or your faction superiors? Why?</label><textarea id="q-opinion" rows="2"></textarea></div>
      <div class="card"><label for="q-drive">What drives you to fight—justice, guilt, revenge, legacy, redemption, or something else?</label><textarea id="q-drive" rows="2"></textarea></div>
      <div class="card"><label for="q-walk-away">What would make you walk away from this life for good?</label><textarea id="q-walk-away" rows="2"></textarea></div>
      <div class="card"><label for="q-secret">What is one major secret you are keeping from the rest of the team?</label><textarea id="q-secret" rows="2"></textarea></div>
      <div class="card"><label for="q-vulnerable">What situation leaves you the most vulnerable—physically, emotionally, or strategically?</label><textarea id="q-vulnerable" rows="2"></textarea></div>
      <div class="card"><label for="q-admire">Which teammate do you admire the most and what do they have that you lack?</label><textarea id="q-admire" rows="2"></textarea></div>
      <div class="card"><label for="q-if-lost">If you lost your powers tomorrow, who would you still be?</label><textarea id="q-if-lost" rows="2"></textarea></div>
    </div>
  </fieldset>


</main>

<!-- PLAYER ACCOUNT MODAL -->
<div class="overlay hidden" id="modal-player" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>The Catalyst Gate</h3>
    <fieldset class="card">
      <legend>Player Account</legend>
      <div class="inline">
        <input id="login-player-name" placeholder="Player name"/>
        <input id="login-player-password" type="password" placeholder="Password"/>
      </div>
      <div class="inline">
        <button id="login-player" class="btn-sm" type="button">Login</button>
        <a id="open-register" href="#">Register</a>
        <a id="open-recover" href="#">Recover</a>
        <button id="logout-player" class="btn-sm" type="button" hidden>Logout</button>
      </div>
    </fieldset>
  </div>
</div>

<!-- PLAYER REGISTRATION MODAL -->
<div class="overlay hidden" id="modal-register" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Register Player</h3>
    <fieldset class="card">
      <legend>Player Account</legend>
      <div class="inline">
        <input id="register-player-name" placeholder="Player name"/>
        <input id="register-player-password" type="password" placeholder="Password"/>
      </div>
      <div class="inline">
        <select id="register-player-question">
          <option value="" disabled selected>Select a security question</option>
          <option value="What was the name of your first D&D character?">What was the name of your first D&D character?</option>
          <option value="What is your favorite D&D class?">What is your favorite D&D class?</option>
          <option value="Who is your current Dungeon Master?">Who is your current Dungeon Master?</option>
        </select>
        <input id="register-player-answer" type="password" placeholder="Security answer"/>
      </div>
      <div class="inline">
        <button id="register-player" class="btn-sm" type="button">Register</button>
      </div>
    </fieldset>
  </div>
</div>

<!-- PASSWORD RECOVERY MODAL -->
<div class="overlay hidden" id="modal-recover" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Recover Password</h3>
    <fieldset class="card">
      <legend>Password Recovery</legend>
      <div class="inline">
        <input id="recover-name" placeholder="Player name"/>
      </div>
      <div class="inline">
        <p id="recover-question"></p>
      </div>
      <div class="inline">
        <input id="recover-answer" type="password" placeholder="Security answer"/>
        <button id="recover-player" class="btn-sm" type="button">Recover</button>
      </div>
    </fieldset>
  </div>
</div>

<div class="overlay hidden" id="modal-dm-login" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>DM Login</h3>
    <fieldset class="card">
      <legend>DM Access</legend>
      <div class="inline">
        <input id="dm-password" type="password" placeholder="DM password"/>
        <button id="login-dm" class="btn-sm" type="button">Login</button>
        <button id="logout-dm" class="btn-sm" type="button" hidden>Logout</button>
      </div>
    </fieldset>
  </div>
</div>

<div class="overlay hidden" id="modal-dm" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Player Characters</h3>
    <div id="dm-player-list" class="catalog"></div>
  </div>
</div>

<!-- WELCOME MODAL -->
<div class="overlay hidden" id="modal-welcome" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Welcome to the Tracker</h3>
    <p>Use the tabs to navigate your sheet. Changes save automatically and work offline.</p>
    <p>If you're new here, register to save your character and access cloud features.</p>
    <div class="actions">
      <button id="welcome-register" class="btn-sm" type="button">Register</button>
      <button id="welcome-ok" type="button">Get Started</button>
    </div>
  </div>
</div>

<!-- HELP MODAL -->
<div class="overlay hidden" id="modal-help" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>How to Use the Tracker</h3>
    <ul class="feature-list">
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3V5.25M18.364 5.63604L16.773 7.22703M21 12H18.75M18.364 18.364L16.773 16.773M12 18.75V21M7.22703 16.773L5.63604 18.364M5.25 12H3M7.22703 7.22703L5.63604 5.63604M15.75 12C15.75 14.0711 14.0711 15.75 12 15.75C9.92893 15.75 8.25 14.0711 8.25 12C8.25 9.92893 9.92893 8.25 12 8.25C14.0711 8.25 15.75 9.92893 15.75 12Z"/>
        </svg>
        <b>Theme toggle:</b> Switch between visual themes with the sun, contrast, or moon icons.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6.75h15m-15 5.25h15m-15 5.25h15"/>
        </svg>
        <b>Main menu:</b> Open for Log&nbsp;In, Character wizard, Encounter tracker, Save, Roll/Flip Log, Campaign Log, Rules, Help, and Players.
      </li>
      <li>
        <span class="icon-group">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <polyline stroke-linecap="round" stroke-linejoin="round" points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/>
            <line stroke-linecap="round" stroke-linejoin="round" x1="13" y1="19" x2="19" y2="13"/>
            <line stroke-linecap="round" stroke-linejoin="round" x1="16" y1="16" x2="20" y2="20"/>
            <line stroke-linecap="round" stroke-linejoin="round" x1="19" y1="21" x2="21" y2="19"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.8132 15.9038L9 18.75L8.1868 15.9038C7.75968 14.4089 6.59112 13.2403 5.09619 12.8132L2.25 12L5.09619 11.1868C6.59113 10.7597 7.75968 9.59112 8.1868 8.09619L9 5.25L9.8132 8.09619C10.2403 9.59113 11.4089 10.7597 12.9038 11.1868L15.75 12L12.9038 12.8132C11.4089 13.2403 10.2403 14.4089 9.8132 15.9038Z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M18.2589 8.71454L18 9.75L17.7411 8.71454C17.4388 7.50533 16.4947 6.56117 15.2855 6.25887L14.25 6L15.2855 5.74113C16.4947 5.43883 17.4388 4.49467 17.7411 3.28546L18 2.25L18.2589 3.28546C18.5612 4.49467 19.5053 5.43883 20.7145 5.74113L21.75 6L20.7145 6.25887C19.5053 6.56117 18.5612 7.50533 18.2589 8.71454Z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.8942 20.5673L16.5 21.75L16.1058 20.5673C15.8818 19.8954 15.3546 19.3682 14.6827 19.1442L13.5 18.75L14.6827 18.3558C15.3546 18.1318 15.8818 17.6046 16.1058 16.9327L16.5 15.75L16.8942 16.9327C17.1182 17.6046 17.6454 18.1318 18.3173 18.3558L19.5 18.75L18.3173 19.1442C17.6454 19.3682 17.1182 19.8954 16.8942 20.5673Z"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5L14.25 2.25L12 10.5H20.25L9.75 21.75L12 13.5H3.75Z"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.04168C10.4077 4.61656 8.30506 3.75 6 3.75C4.94809 3.75 3.93834 3.93046 3 4.26212V18.5121C3.93834 18.1805 4.94809 18 6 18C8.30506 18 10.4077 18.8666 12 20.2917M12 6.04168C13.5923 4.61656 15.6949 3.75 18 3.75C19.0519 3.75 20.0617 3.93046 21 4.26212V18.5121C20.0617 18.1805 19.0519 18 18 18C15.6949 18 13.5923 18.8666 12 20.2917M12 6.04168V20.2917"/>
          </svg>
        </span>
        <b>Tab navigation:</b> Use Combat, Abilities, Powers, Gear, and Story icons to switch sections.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <polyline stroke-linecap="round" stroke-linejoin="round" points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/>
          <line stroke-linecap="round" stroke-linejoin="round" x1="13" y1="19" x2="19" y2="13"/>
          <line stroke-linecap="round" stroke-linejoin="round" x1="16" y1="16" x2="20" y2="20"/>
          <line stroke-linecap="round" stroke-linejoin="round" x1="19" y1="21" x2="21" y2="19"/>
        </svg>
        <b>Combat tools:</b> Roll dice and coins, manage HP/SP, death saves, initiative, defense stats, and conditions.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z"/>
        </svg>
        <b>Character creation wizard:</b> Build a new character step by step.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z"/>
        </svg>
        <b>Encounter tracker:</b> Manage encounters and turn order.
      </li>
      <li>
        <span class="icon-group">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
          </svg>
        </span>
        <b>Dice rolling &amp; coin flips:</b> Use Roll/Flip Log to make rolls or flips and review results.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/>
        </svg>
        <b>Campaign &amp; roll logs:</b> Keep notes and history in the Campaign Log and Roll/Flip Log.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>
        </svg>
        <b>Gear catalog:</b> Browse equipment on the Gear tab and open the gear catalog.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"/>
        </svg>
        <b>Rules reference:</b> Read the Character Creation Guide from the Rules menu.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"/>
        </svg>
        <b>Player &amp; DM login:</b> Use Log&nbsp;In or the DM link to access shared tools.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z"/>
        </svg>
        <b>Save characters:</b> Save your character locally and in the cloud after logging in.
      </li>
      <li>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"/>
        </svg>
        <b>Offline auto-saving:</b> Your changes save automatically in the browser.
      </li>
    </ul>
  </div>
</div>

<!-- INITIATIVE MODAL -->
<div class="overlay hidden" id="modal-enc" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Encounter Tracker</h3>
    <fieldset class="inline">
      <legend class="sr-only">Add Combatant</legend>
      <label for="enc-name" class="sr-only">Name</label>
      <input id="enc-name" placeholder="Name"/>
      <label for="enc-init" class="sr-only">Init</label>
      <input id="enc-init" type="number" inputmode="numeric" placeholder="Init"/>
      <button id="enc-add" class="btn-sm">Add</button>
    </fieldset>
    <div id="enc-list" class="catalog" style="margin-top:8px"></div>
    <div class="actions">
      <button id="enc-prev" class="btn-sm">Prev Turn</button>
      <button id="enc-next" class="btn-sm">Next Turn</button>
      <button id="enc-reset" class="btn-sm">Reset</button>
    </div>
  </div>
</div>

<div class="overlay hidden" id="modal-hp-roll" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Add Tier HP</h3>
    <label for="hp-roll-input" class="sr-only">Tier HP Bonus</label>
    <input id="hp-roll-input" type="number" inputmode="numeric" placeholder="Tier HP Bonus"/>
    <ul id="hp-roll-list"></ul>
    <div class="actions">
      <button id="hp-roll-save" class="btn-sm">Add</button>
      <button class="btn-sm" data-close>Cancel</button>
    </div>
  </div>
</div>


<!-- LOG MODAL -->
<div class="overlay hidden" id="modal-log" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Recent Log</h3>
    <div class="grid grid-2">
      <div><h4 style="margin:0">Dice</h4><div id="log-dice" class="catalog"></div></div>
      <div><h4 style="margin:0">Coins</h4><div id="log-coin" class="catalog"></div></div>
    </div>
    <div class="actions"><button id="log-full" class="btn-sm">Full Log</button><button class="btn-sm" data-close>Close</button></div>
  </div>
</div>


<div class="overlay hidden" id="modal-campaign" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Campaign Log</h3>
    <label for="campaign-entry" class="sr-only">Campaign Log Entry</label>
    <textarea id="campaign-entry" rows="2" placeholder="Session notes..."></textarea>
    <div class="actions">
      <button id="campaign-add" class="btn-sm" style="max-width:140px">Add Entry</button>
    </div>
    <div id="campaign-log" class="catalog"></div>
    <div class="actions"><button class="btn-sm" data-close>Close</button></div>
  </div>
</div>

<div class="overlay hidden" id="modal-log-full" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Full Log</h3>
    <div class="grid grid-2">
      <div><h4 style="margin:0">Dice</h4><div id="full-log-dice" class="catalog"></div></div>
      <div><h4 style="margin:0">Coins</h4><div id="full-log-coin" class="catalog"></div></div>
    </div>
    <div class="actions"><button class="btn-sm" data-close>Close</button></div>
  </div>
</div>

<div class="overlay hidden" id="modal-faction-perk" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Faction Perk" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Faction Perk</h3>
    <ul id="modal-faction-perk-list" class="perk-list"></ul>
  </div>
</div>


<!-- GEAR CATALOG -->
<div class="overlay hidden" id="modal-catalog" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" tabindex="-1" style="max-width:900px">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Gear Catalog</h3>
    <fieldset class="inline" style="margin:6px 0">
      <legend class="sr-only">Filters</legend>
      <label for="catalog-filter-style" class="sr-only">Style</label>
      <select id="catalog-filter-style" style="max-width:260px"></select>
      <label for="catalog-filter-type" class="sr-only">Type</label>
      <select id="catalog-filter-type" style="max-width:180px"><option value="">All Types</option><option>Armor</option><option>Shield</option><option>Utility</option></select>
      <label for="catalog-filter-rarity" class="sr-only">Rarity</label>
      <select id="catalog-filter-rarity" style="max-width:160px"><option value="">All Rarities</option><option>Common</option><option>Uncommon</option><option>Rare</option><option>Elite</option><option>Legendary</option></select>
      <label for="catalog-search" class="sr-only">Search</label>
      <input id="catalog-search" placeholder="Search..."/>
    </fieldset>
    <div id="catalog-list" class="catalog"></div>
</div>
</div>

<!-- CHARACTER CREATION WIZARD -->
<div class="overlay hidden" id="modal-wizard" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Character Creation Wizard" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <div id="wizard-steps">
      <div class="wizard-step">
        <h3>Classification</h3>
        <select id="wiz-classification">
          <option value="">Select one</option>
          <option>Mutant</option>
          <option>Enhanced Human</option>
          <option>Magic User</option>
          <option>Alien/Extraterrestrial</option>
          <option>Mystical Being</option>
        </select>
      </div>
      <div class="wizard-step">
        <h3>Power Style</h3>
        <div class="grid grid-2">
          <div class="card"><label for="wiz-power-style">Primary Style</label>
            <select id="wiz-power-style">
              <option value="">Select one</option>
              <option>Physical Powerhouse</option>
              <option>Energy Manipulator</option>
              <option>Speedster</option>
              <option>Telekinetic/Psychic</option>
              <option>Illusionist</option>
              <option>Shape-shifter</option>
              <option>Elemental Controller</option>
            </select>
          </div>
          <div class="card"><label for="wiz-power-style-2">Secondary Style</label>
            <select id="wiz-power-style-2">
              <option value="">Select one</option>
              <option>None</option>
              <option>Physical Powerhouse</option>
              <option>Energy Manipulator</option>
              <option>Speedster</option>
              <option>Telekinetic/Psychic</option>
              <option>Illusionist</option>
              <option>Shape-shifter</option>
              <option>Elemental Controller</option>
            </select>
          </div>
        </div>
      </div>
      <div class="wizard-step">
        <h3>Origin Story</h3>
        <select id="wiz-origin">
          <option value="">Select one</option>
          <option>The Accident</option>
          <option>The Experiment</option>
          <option>The Legacy</option>
          <option>The Awakening</option>
          <option>The Pact</option>
          <option>The Lost Time</option>
          <option>The Exposure</option>
          <option>The Rebirth</option>
          <option>The Vigil</option>
          <option>The Redemption</option>
        </select>
      </div>
      <div class="wizard-step">
        <h3>Ability Scores</h3>
        <div id="wizard-abil-grid" class="grid ability-grid"></div>
      </div>
      <div class="wizard-step">
        <h3>Customize Powers &amp; Gear</h3>
        <p>Use the buttons below to add starting powers and gear.</p>
        <div class="actions" style="justify-content:center">
          <button id="wiz-add-power">Add Power</button>
          <button id="wiz-add-weapon">Add Weapon</button>
          <button id="wiz-add-armor">Add Armor</button>
          <button id="wiz-add-item">Add Item</button>
        </div>
      </div>
      <div class="wizard-step">
        <h3>Alignment</h3>
        <select id="wiz-alignment">
          <option value="">Select one</option>
          <option>Paragon (Lawful Light)</option>
          <option>Guardian (Neutral Light)</option>
          <option>Vigilante (Chaotic Light)</option>
          <option>Sentinel (Lawful Neutral)</option>
          <option>Outsider (True Neutral)</option>
          <option>Wildcard (Chaotic Neutral)</option>
          <option>Inquisitor (Lawful Shadow)</option>
          <option>Anti-Hero (Neutral Shadow)</option>
          <option>Renegade (Chaotic Shadow)</option>
        </select>
      </div>
      <div class="wizard-step">
        <h3>Story</h3>
        <div class="grid grid-1">
          <div class="card"><label for="wiz-superhero">Superhero Identity</label><input id="wiz-superhero" placeholder="Vigilante Name"/></div>
          <div class="card"><label for="wiz-secret">Secret Identity</label><input id="wiz-secret"/></div>
          <div class="card"><label for="wiz-public">Public Identity</label><select id="wiz-public"><option value="Public">Public</option><option value="Secret">Secret</option></select></div>
        </div>
      </div>
    </div>
    <div class="wizard-nav">
      <button id="wizard-prev">Back</button>
      <span id="wizard-progress" aria-live="polite"></span>
      <button id="wizard-next">Next</button>
    </div>
  </div>
</div>

<!-- RULES (CCCG PDF) -->
<div class="overlay hidden" id="modal-rules" aria-hidden="true">
  <div class="modal modal-rules" role="dialog" aria-modal="true" aria-label="CCCG — Character Creation Guide" tabindex="-1">
    <button class="x" data-close aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
      </svg>
    </button>
    <div class="pdf-controls">
      <button id="cccg-page-up" class="icon" aria-label="Previous Page">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0-7 7m7-7 7 7"/>
        </svg>
      </button>
      <button id="cccg-page-down" class="icon" aria-label="Next Page">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m0 0 7-7m-7 7-7-7"/>
        </svg>
      </button>
    </div>
    <canvas id="cccg-canvas"></canvas>
  </div>
</div>


  <footer>
  <p>When the whole world tells you to move, it's your job to plant yourself like a tree by the river of truth and tell the whole world - no, YOU move.</p>
  <p>Product of XoVrom industries ® 2025</p>
 <p><a href="#" id="dm-login-link" title="Dungeon Master login">DM Login</a></p>
</footer>
<div id="down-animation" aria-hidden="true">⚠️</div>
<div id="death-animation" aria-hidden="true">💀</div>
<div id="damage-animation" aria-hidden="true"></div>
<div id="heal-animation" aria-hidden="true"></div>
<div id="save-animation" aria-hidden="true">💾</div>
<div id="coin-animation" aria-hidden="true"></div>
<div id="sp-animation" aria-hidden="true"></div>
<div class="toast" id="toast" role="status" aria-live="polite"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
<script type="module" src="scripts/users.js"></script>
<script type="module" src="scripts/main.js"></script>
<style>
  .cc-btn{position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:999px;background:#1e2740;color:#e7e9ee;border:1px solid #2c3454;cursor:pointer;z-index:9999}
  .cc-modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);z-index:9998}
  .cc-panel{position:absolute;right:16px;bottom:72px;width:min(92vw,460px);max-height:min(85vh,720px);display:flex;flex-direction:column;background:#0f1320;color:#e7e9ee;border:1px solid #263155;border-radius:12px;overflow:hidden}
  .cc-head{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #212b4c}
  .cc-title{font:600 15px system-ui;margin-right:auto}
  .cc-log{padding:10px;overflow:auto;flex:1}
  .cc-b{padding:8px 10px;margin:6px 0;border-radius:8px;white-space:pre-wrap;background:#12182a}
  .cc-user{background:#172034}
  .cc-sys{background:#11151f;border:1px dashed #27314b;color:#b3c0e0}
  .cc-row{display:flex;gap:8px;padding:10px;border-top:1px solid #212b4c}
  .cc-row textarea{flex:1;min-height:60px;background:#0b1020;color:#e7e9ee;border:1px solid #2a2f3f;border-radius:8px;padding:8px}
  .cc-row button{background:#1e2740;border:1px solid #2c3454;color:#e7e9ee;border-radius:8px;padding:8px 12px;cursor:pointer}
  .cc-pill{display:flex;align-items:center;gap:6px;border:1px solid #2b2f3a;background:#141827;border-radius:999px;padding:4px 8px;font-size:12px}
  .cc-controls{display:flex;gap:8px;flex-wrap:wrap;padding:8px 10px;border-bottom:1px solid #212b4c}
</style>

<button class="cc-btn" id="cc-open">Ask the Assistant</button>
<div class="cc-modal" id="cc-modal" aria-hidden="true">
  <div class="cc-panel" role="dialog" aria-modal="true" aria-label="Catalyst Core Assistant">
    <div class="cc-head">
      <div class="cc-title">Catalyst Core Assistant</div>
      <div class="cc-pill"><label><input type="checkbox" id="cc-gm"> GM Mode</label></div>
      <div class="cc-pill"><label><input type="checkbox" id="cc-sp" checked> Spoiler Safe</label></div>
      <button id="cc-close" title="Close">✕</button>
    </div>
    <div class="cc-controls">
      <div class="cc-pill">Model:
        <select id="cc-model">
          <option value="openai/gpt-oss-20b:free" selected>gpt-oss-20b (free)</option>
        </select>
      </div>
    </div>
    <div id="cc-log" class="cc-log">
      <div class="cc-b cc-sys">Hosted assistant via OpenRouter proxy. Local Codex loaded.</div>
    </div>
    <div class="cc-row">
      <textarea id="cc-msg" placeholder="Ask about rules, gear, SP, CAP, alignments…"></textarea>
      <button id="cc-send">Send</button>
    </div>
  </div>
</div>

<script type="module">
  const PROXY_URL = "https://cc-assistant-proxy.<subdomain>.workers.dev/chat"; // set to your Worker URL

  const $ = (s)=>document.querySelector(s);
  const openBtn=$("#cc-open"), modal=$("#cc-modal"), closeBtn=$("#cc-close"), menuAI=$("#btn-ai");
  const log=$("#cc-log"), sendBtn=$("#cc-send"), msg=$("#cc-msg");
  const selModel=$("#cc-model"), gm=$("#cc-gm"), sp=$("#cc-sp");

  const append=(cls, text)=>{ const d=document.createElement("div"); d.className="cc-b "+cls; d.textContent=text; log.appendChild(d); log.scrollTop=log.scrollHeight; return d; };

  const SYSTEM_PROMPT = `You are the Catalyst Core Campaign Assistant.
Use concise, plain language. No emojis. If Spoiler Safe is ON, avoid hidden twists or secret identities. If GM Mode is ON, add a short "GM Tips" section.
When helpful, format with: Summary; Steps; Examples; GM Tips (GM only).
Prefer citing Codex keys in square brackets when present: [mechanic:sp], [gear:armor.tactical_mesh_undersuit], [classgear:speedster.armor.kinetic_glide_suit].`;

  const CODEX = [
  {
    "type": "classification",
    "key": "mutant",
    "text": "Reroll one failed saving throw per long rest."
  },
  {
    "type": "classification",
    "key": "enhanced_human",
    "text": "Gain advantage on all Technology-related checks."
  },
  {
    "type": "classification",
    "key": "magic_user",
    "text": "Cast one minor magical effect (prestidigitation) per long rest."
  },
  {
    "type": "classification",
    "key": "alien",
    "text": "Immune to environmental hazards; no penalty to movement in rough terrain."
  },
  {
    "type": "classification",
    "key": "mystical_being",
    "text": "+2 to Persuasion or Intimidation checks."
  },
  {
    "type": "powerstyle",
    "key": "physical_powerhouse",
    "text": "Cut one attack by half once per combat encounter."
  },
  {
    "type": "powerstyle",
    "key": "energy_manipulator",
    "text": "Reroll 1s once per turn."
  },
  {
    "type": "powerstyle",
    "key": "speedster",
    "text": "+10 ft movement and +1 AC while moving 20+ ft."
  },
  {
    "type": "powerstyle",
    "key": "telekinetic_psychic",
    "text": "For one turn force enemies to reroll all rolls above a 17 once per rest."
  },
  {
    "type": "powerstyle",
    "key": "illusionist",
    "text": "Create a 1-minute decoy once per combat encounter."
  },
  {
    "type": "powerstyle",
    "key": "shape_shifter",
    "text": "Advantage on Deception; disguise freely."
  },
  {
    "type": "powerstyle",
    "key": "elemental_controller",
    "text": "+2 to hit and +5 to damage once per turn when using elemental powers."
  },
  {
    "type": "origin",
    "key": "accident",
    "text": "Resistance to one damage type."
  },
  {
    "type": "origin",
    "key": "experiment",
    "text": "Reroll a failed CON or INT save once per long rest."
  },
  {
    "type": "origin",
    "key": "legacy",
    "text": "Use the powers of one other character you’ve met or are related to once per long rest."
  },
  {
    "type": "origin",
    "key": "awakening",
    "text": "+5 to hit and +10 to damage when below ½ HP."
  },
  {
    "type": "origin",
    "key": "pact",
    "text": "Auto-success on one save or +10 to any roll once per long rest."
  },
  {
    "type": "origin",
    "key": "lost_time",
    "text": "Once per combat, when using a power, roll a d20 (DC 17). On a success it becomes a “Skill Move”: no SP cost and +1d6 bonus."
  },
  {
    "type": "origin",
    "key": "exposure",
    "text": "+5 elemental damage once per round."
  },
  {
    "type": "origin",
    "key": "rebirth",
    "text": "If knocked out, stand; gain 1 HP and resistance to all damage for 1 round."
  },
  {
    "type": "origin",
    "key": "vigil",
    "text": "Create a shield once per combat reducing incoming damage for all allies to 0 for 1 turn."
  },
  {
    "type": "origin",
    "key": "redemption",
    "text": "Once/day take damage for an ally within move range; they heal 1d6 HP and gain advantage; after combat you gain advantage on all saves until dawn."
  },
  {
    "type": "mechanic",
    "key": "tc",
    "text": "Base TC = 10 + DEX modifier + Armor/Shield bonuses + Power/Origin bonuses."
  },
  {
    "type": "mechanic",
    "key": "hp",
    "text": "HP = 30 + CON modifier + (Tier Bonus × 1d10). Heroic tiers add +1d10 to +5d10."
  },
  {
    "type": "mechanic",
    "key": "sp",
    "text": "SP = 5 + CON modifier; fully regenerates at the start of each combat round; powers cost 1–5 SP."
  },
  {
    "type": "mechanic",
    "key": "sp_costs",
    "text": "1 SP basic; 2 SP core/status; 3 SP AoE/enhanced/heal; 4 SP strong AoE/hard CC; 5 SP ultimate (10-round cooldown)."
  },
  {
    "type": "mechanic",
    "key": "initiative",
    "text": "1d20 + DEX modifier."
  },
  {
    "type": "mechanic",
    "key": "action_economy",
    "text": "Each turn: 1 Action, 1 Movement, 1 Reaction; some features grant a Bonus Action."
  },
  {
    "type": "mechanic",
    "key": "crit",
    "text": "Natural 20: double the damage dice."
  },
  {
    "type": "alignment",
    "key": "paragon",
    "text": "Auto-succeed one Charisma check with civilians or allies per session."
  },
  {
    "type": "alignment",
    "key": "guardian",
    "text": "Once per session, restore 1d6 HP or 1 SP to an ally as a bonus action."
  },
  {
    "type": "alignment",
    "key": "vigilante",
    "text": "Ignore opportunity attacks when moving toward a threat or hostage."
  },
  {
    "type": "alignment",
    "key": "sentinel",
    "text": "+1 to all saves when acting on orders or directives."
  },
  {
    "type": "alignment",
    "key": "outsider",
    "text": "Once per session, reroll any roll OR remove one condition from yourself."
  },
  {
    "type": "alignment",
    "key": "wildcard",
    "text": "Advantage on Initiative and Deception once per combat."
  },
  {
    "type": "alignment",
    "key": "inquisitor",
    "text": "Once per session, deal maximum damage to enemies the GM labels “criminal.”"
  },
  {
    "type": "alignment",
    "key": "anti_hero",
    "text": "Heal 1d6 HP when defeating an enemy while no allies are within 10 ft."
  },
  {
    "type": "alignment",
    "key": "renegade",
    "text": "Once per combat, add +1d6 damage when attacking from stealth or surprise."
  },
  {
    "type": "glossary",
    "key": "sp_def",
    "text": "Stamina Points; regenerate fully at the start of each round."
  },
  {
    "type": "glossary",
    "key": "per_session",
    "text": "Usable once during a full play session."
  },
  {
    "type": "glossary",
    "key": "per_combat",
    "text": "Resets each new combat."
  },
  {
    "type": "glossary",
    "key": "per_long_rest",
    "text": "Equivalent to per session unless longer rest rules are used."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "common",
    "key": "tactical_mesh_undersuit",
    "text": "+1 TC. Lightweight and breathable."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "common",
    "key": "utility_combat_jacket",
    "text": "+1 TC; +1 to Stealth checks."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "common",
    "key": "synthetic_kevlayer_vest",
    "text": "+1 TC; reduce fall damage by 5."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "common",
    "key": "friction_lined_undersuit",
    "text": "+1 TC; ignore heat environmental penalties."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "guardian_field_plate",
    "text": "+2 TC; +1 to STR or DEX saves."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "enviro_matched_armor",
    "text": "+2 TC; advantage on saves vs weather/environment."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "hardened_utility_armor",
    "text": "+2 TC; resist slashing once/day."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "impact_sensor_vest",
    "text": "+2 TC; warns before surprise rounds (no flat-footed penalty)."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "rare",
    "key": "reflex_reinforced_vest",
    "text": "+3 TC; advantage vs being knocked prone."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "rare",
    "key": "haztech_core_plating",
    "text": "+3 TC; resistance to poison, acid, or radiation (choose one)."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "rare",
    "key": "tactical_absorption_lining",
    "text": "+3 TC; +1 SP if hit by an AoE."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "rare",
    "key": "servo_spine_rig",
    "text": "+3 TC; +5 ft movement."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "elite",
    "key": "kinetic_nullifier_suit",
    "text": "+3 TC; +1 SP regen when not hit during a round."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "elite",
    "key": "omni_response_mesh",
    "text": "+3 TC; ignore difficult terrain."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "elite",
    "key": "deflection_halo_exosuit",
    "text": "+3 TC; first hit each encounter is reduced by 5."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "elite",
    "key": "phase_shield_bodysuit",
    "text": "+3 TC; +1 DEX save and resistance to psychic."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "legendary",
    "key": "aegis_core_cuirass",
    "text": "+4 TC; once/session auto-block one physical hit."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "legendary",
    "key": "temporal_fold_plating",
    "text": "+3 TC; +2 Initiative while worn."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "legendary",
    "key": "astral_guard_harness",
    "text": "+3 TC; resistance to force and psychic."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "legendary",
    "key": "echoweave_armor",
    "text": "+4 TC; if an attacker misses once, they take −1 to hit thereafter."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "legendary",
    "key": "dimensional_layered_vest",
    "text": "+3 TC; when hit, teleport 10 ft once/short rest."
  },
  {
    "type": "gear",
    "gear": "armor",
    "rarity": "legendary",
    "key": "star_tether_harness",
    "text": "+4 TC; immunity to the first critical hit against you each day."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "common",
    "key": "polysteel_riot_plate",
    "text": "+1 TC vs melee."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "common",
    "key": "deflector_ring_gauntlet",
    "text": "+1 TC; +1 INT saves."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "common",
    "key": "kiteboard_bracer",
    "text": "+1 TC while moving."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "common",
    "key": "magseal_wrist_guard",
    "text": "+1 TC; resistance to grappling."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "echo_deflector_disk",
    "text": "+2 TC vs ranged attacks."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "reactive_feedback_guard",
    "text": "+2 TC; attacker takes 1 lightning damage on a miss."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "tuned_kinetic_bracer",
    "text": "+2 TC vs blunt/force."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "thermal_diffuser_plate",
    "text": "+2 TC vs fire/cold-based powers."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "rare",
    "key": "surge_buffer_barrier",
    "text": "+2 TC; negate one elemental attack per day."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "rare",
    "key": "quantum_stitch_bracer",
    "text": "+2 TC; phase through one AoE per combat."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "rare",
    "key": "displacement_arc_shield",
    "text": "+2 TC; 50% miss chance once/day for enemies."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "rare",
    "key": "aether_circuit_shard",
    "text": "+2 TC; recharge 1 SP when you roll a natural 20."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "elite",
    "key": "adaptive_reflex_wall",
    "text": "+3 TC; reactive +1 TC boost if hit."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "elite",
    "key": "mirror_field_buckler",
    "text": "+3 TC; reflect one ranged hit per encounter."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "elite",
    "key": "titan_barrier_cuff",
    "text": "+3 TC; +1 CON save when resisting critical hits."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "elite",
    "key": "phase_dome_generator",
    "text": "+3 TC; adjacent allies gain +1 TC."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "legendary",
    "key": "nova_dome_projector",
    "text": "Once/day, allies within 10 ft gain +2 TC for 1 round."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "legendary",
    "key": "quantum_fold_bracer",
    "text": "+2 TC; teleport 5 ft as a reaction to being targeted."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "legendary",
    "key": "sentinel_sigil_shield",
    "text": "+3 TC; store 1 blocked hit and unleash it as force damage next turn."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "legendary",
    "key": "temporal_rift_shield",
    "text": "+3 TC; once/round shift damage to the next round."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "legendary",
    "key": "eclipse_generator",
    "text": "+3 TC; grant total concealment once/day."
  },
  {
    "type": "gear",
    "gear": "shield",
    "rarity": "legendary",
    "key": "fortress_light_beacon",
    "text": "+3 TC; allies within 15 ft cannot be surprised."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "common",
    "key": "combat_reflex_enhancer",
    "text": "+1 TC during the first round."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "common",
    "key": "emergency_blink_chip",
    "text": "+1 TC; teleport 5 ft as a bonus action once/long rest."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "common",
    "key": "optic_flash_spike",
    "text": "+1 TC; blind one adjacent attacker as a reaction (1/day)."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "common",
    "key": "thermal_regulation_patch",
    "text": "+1 TC vs elemental terrain effects."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "adrenaline_booster_patch",
    "text": "+2 TC while under 50% HP."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "pulse_guard_band",
    "text": "+2 TC for 1 round after spending 3+ SP."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "reflex_timer_loop",
    "text": "+2 TC vs AoE effects."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "hazard_compensation_implant",
    "text": "+2 TC; ignore environment conditions for 1 hour."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "rare",
    "key": "perception_sync_visor",
    "text": "+1 TC and +1 Passive Perception."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "rare",
    "key": "directional_flux_beacon",
    "text": "Once/day, reroute one ranged power away from you."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "rare",
    "key": "kinetic_assist_boots",
    "text": "+2 TC when moving more than 15 ft."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "rare",
    "key": "echo_reversal_node",
    "text": "Once/day, negate one condition on yourself."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "elite",
    "key": "phase_step_belt",
    "text": "+2 TC; ignore difficult terrain while active."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "elite",
    "key": "temporal_leech_ring",
    "text": "+2 TC; steal 1 SP when you dodge."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "elite",
    "key": "nullskin_emitter",
    "text": "+2 TC; immune to Burn, Freeze, or Stun (choose each day)."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "elite",
    "key": "aegis_burst_pack",
    "text": "+3 TC for 1 turn when hit (1/short rest)."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "legendary",
    "key": "chrono_anchor_locket",
    "text": "Once/day reset position & TC to start of turn."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "legendary",
    "key": "null_pulse_core",
    "text": "Emit a wave that gives all allies +2 TC for 1 round."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "legendary",
    "key": "omniguard_relay_matrix",
    "text": "+2 TC; allies within 5 ft gain +1 TC."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "legendary",
    "key": "loopfield_projector",
    "text": "Reflect a failed attack once per scene."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "legendary",
    "key": "heartsync_signal_band",
    "text": "Share your TC with an ally within 10 ft for 1 round."
  },
  {
    "type": "gear",
    "gear": "utility",
    "rarity": "legendary",
    "key": "dimensional_safeguard_disk",
    "text": "Immune to critical hits and one chosen damage type for 1 turn."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "common",
    "key": "combat_vest_mk_i",
    "text": "+1 TC."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "shockframe_bodysuit",
    "text": "+2 TC; +1 STR saves."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "rare",
    "key": "tectonic_armor_rig",
    "text": "+3 TC; immune to knockback."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "elite",
    "key": "ironspike_chassis",
    "text": "+3 TC; +1 SP regen when stationary."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "legendary",
    "key": "goliath_core_plate",
    "text": "+4 TC; once/day reduce one attack to 0."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "legendary",
    "key": "unbreakable_frame",
    "text": "+3 TC; immune to stun and restraint."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "armor",
    "rarity": "legendary",
    "key": "craterwalker_shell",
    "text": "+3 TC; ignore damage under 5."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "common",
    "key": "bunker_bracer",
    "text": "+1 TC vs melee."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "mag_pulse_forearm",
    "text": "+2 TC vs bludgeoning."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "rare",
    "key": "spinal_lock_wall",
    "text": "+2 TC; cannot be moved."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "elite",
    "key": "g_force_displacer",
    "text": "+3 TC vs charges."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "legendary",
    "key": "atlas_aegis",
    "text": "+3 TC; auto-block one melee hit/encounter."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "legendary",
    "key": "anchor_guard",
    "text": "+2 TC; adjacent allies gain +1 TC."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "shield",
    "rarity": "legendary",
    "key": "nullwave_core_shield",
    "text": "+2 TC; crits against you become normal hits."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "common",
    "key": "steel_boots",
    "text": "+1 TC while stationary."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "momentum_harness",
    "text": "+2 TC if immobile."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "rare",
    "key": "titan_reinforcers",
    "text": "+2 TC when under half HP."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "elite",
    "key": "seismic_stabilizers",
    "text": "On hit, ground shock (DEX 15 or fall prone)."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "legendary",
    "key": "graviton_stompers",
    "text": "+2 TC; creates tremor zone."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "legendary",
    "key": "battle_cry_driver",
    "text": "+2 TC; nearby enemies −1 to hit."
  },
  {
    "type": "classgear",
    "class": "physical_powerhouse",
    "gear": "utility",
    "rarity": "legendary",
    "key": "overrun_barrier_core",
    "text": "Reflect melee damage once per round."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "common",
    "key": "insulated_undersuit",
    "text": "+1 TC vs electric."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "livewire_vest",
    "text": "+2 TC vs energy."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "rare",
    "key": "overload_plate",
    "text": "+3 TC; causes feedback when hit."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "elite",
    "key": "powernet_mesh",
    "text": "Absorb 1 SP on the first hit each round."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "legendary",
    "key": "stormcell_frame",
    "text": "+3 TC; gain 1 SP when hit."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "legendary",
    "key": "voltage_cradle",
    "text": "+4 TC vs energy; immune to Burn."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "armor",
    "rarity": "legendary",
    "key": "sparkforge_armor",
    "text": "Melee attackers take 1d6 lightning."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "common",
    "key": "arc_bracer",
    "text": "+1 TC vs ranged."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "plasma_flicker_disk",
    "text": "+2 TC vs ranged powers."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "rare",
    "key": "amp_reflect_array",
    "text": "Reflect 1 energy attack/day."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "elite",
    "key": "phase_capacitor_barrier",
    "text": "+2 TC; attackers reroll max damage."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "legendary",
    "key": "electro_veil_dome",
    "text": "+2 TC; pulses 1d4 lightning on miss."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "legendary",
    "key": "containment_prism",
    "text": "Nullify 1 AoE attack per day."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "shield",
    "rarity": "legendary",
    "key": "aurora_field_generator",
    "text": "+1 TC to all allies."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "common",
    "key": "battery_loop",
    "text": "+1 TC after spending 5+ SP."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "charge_filter_mod",
    "text": "Recharge 1 SP when hit by energy."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "rare",
    "key": "amplifier_ring",
    "text": "+2 TC after using a 4+ SP power."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "elite",
    "key": "core_resistor_relay",
    "text": "Steal 1 SP from attacker on hit."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "legendary",
    "key": "quantum_pulse_array",
    "text": "+2 TC while channeling."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "legendary",
    "key": "shockwave_cloak",
    "text": "Pulse all enemies back 10 ft once/day."
  },
  {
    "type": "classgear",
    "class": "energy_manipulator",
    "gear": "utility",
    "rarity": "legendary",
    "key": "static_soul_engine",
    "text": "Bank unused SP and apply it later."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "common",
    "key": "aerodynamic_skinsuit",
    "text": "+1 TC; +10 ft movement."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "vibra_lining_weave",
    "text": "+2 TC; +1 DEX save."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "rare",
    "key": "kinetic_glide_suit",
    "text": "+3 TC while moving 20+ ft."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "elite",
    "key": "reactive_velocity_mesh",
    "text": "+2 TC; +2 Initiative."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "legendary",
    "key": "flashphase_armor",
    "text": "+3 TC; once/day teleport 30 ft when hit."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "legendary",
    "key": "chrono_surge_shell",
    "text": "+3 TC; attackers reroll hits when you Dash."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "armor",
    "rarity": "legendary",
    "key": "slipstream_frame",
    "text": "+3 TC; Dash as a free action once/turn."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "common",
    "key": "momentum_redirector",
    "text": "+2 TC if moved 10+ ft."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "mirrorstep_band",
    "text": "+1 TC; if you dashed last turn, attacker rolls twice and takes lower."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "rare",
    "key": "temporal_slip_device",
    "text": "Reroll 1 failed TC save per round."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "elite",
    "key": "phase_echo_shroud",
    "text": "+2 TC; phase through one attack/day."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "legendary",
    "key": "velocity_ward_matrix",
    "text": "+3 TC while moving; enemies −1 to hit."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "legendary",
    "key": "slip_trace_halo",
    "text": "Once/day you become untargetable for 1 round."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "shield",
    "rarity": "legendary",
    "key": "kaleidoshift_generator",
    "text": "+2 TC; appear in multiple places."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "common",
    "key": "reflex_anchor_boots",
    "text": "+2 TC on opportunity attacks."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "stutter_blink_harness",
    "text": "+1 TC; reaction teleport 5 ft once/combat."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "rare",
    "key": "vortex_runner_pads",
    "text": "If you sprint 40+ ft, +3 TC next turn."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "elite",
    "key": "hyperstep_treads",
    "text": "+2 TC; ignore difficult terrain."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "legendary",
    "key": "timefract_jetboots",
    "text": "+2 TC & extra movement when you win Initiative."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "legendary",
    "key": "sonic_dash_loops",
    "text": "Create afterimage; enemies may hit illusion on miss."
  },
  {
    "type": "classgear",
    "class": "speedster",
    "gear": "utility",
    "rarity": "legendary",
    "key": "momentum_prism_core",
    "text": "Reflect incoming damage if you dashed last turn."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "common",
    "key": "neuro_sync_bodysuit",
    "text": "+1 TC; +1 INT save."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "psionic_feedback_mesh",
    "text": "+2 TC; attacker takes 1 psychic on a miss."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "rare",
    "key": "thoughtweave_lining",
    "text": "+3 TC; +1 vs psychic attacks."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "elite",
    "key": "willsteel_harness",
    "text": "+2 TC; immune to Confused."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "legendary",
    "key": "mindlock_vestment",
    "text": "+3 TC; all WIS saves at advantage."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "legendary",
    "key": "neuron_mirror_shell",
    "text": "+3 TC; reflect 1 mind power/day."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "armor",
    "rarity": "legendary",
    "key": "etherial_cortex_plate",
    "text": "+4 TC; cannot be targeted by telepathy."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "common",
    "key": "mind_ward_halo",
    "text": "+2 TC vs mental effects."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "kinetic_catch_gauntlet",
    "text": "+2 TC; catch 1 thrown item/round."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "rare",
    "key": "psy_bond_mirror",
    "text": "+2 TC; attacker may save or hit themselves once/day."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "elite",
    "key": "synaptic_repulsion_field",
    "text": "+3 TC vs psychic."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "legendary",
    "key": "astral_reflection_screen",
    "text": "Auto-deflect 1 psychic attack/day."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "legendary",
    "key": "ego_barrier_core",
    "text": "+2 TC; suppress all emotion-based effects."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "shield",
    "rarity": "legendary",
    "key": "empathic_shunt_dome",
    "text": "Redirect emotional powers to a nearby target."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "common",
    "key": "telekinetic_aegis",
    "text": "Spend 1 SP for +2 TC for 1 round."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "predictive_focus_lens",
    "text": "+1 TC if attacker is visible."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "rare",
    "key": "cognitive_anchor_crystal",
    "text": "+2 TC when stunned/confused."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "elite",
    "key": "psi_loop_amplifier",
    "text": "+2 TC; recharge 1 SP if you succeed a save."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "legendary",
    "key": "clarity_pulse_node",
    "text": "Auto-save vs charm/confuse once/scene."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "legendary",
    "key": "chrono_mental_bracer",
    "text": "Delay incoming mind-effect by 1 round."
  },
  {
    "type": "classgear",
    "class": "telekinetic_psychic",
    "gear": "utility",
    "rarity": "legendary",
    "key": "quantum_intuition_harness",
    "text": "Always act first in surprise rounds."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "common",
    "key": "refraction_cloak",
    "text": "+2 TC vs first attack each round."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "prism_mesh_bodysuit",
    "text": "+1 TC; advantage on Stealth."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "rare",
    "key": "camouflage_lattice",
    "text": "+1 TC in cover; +1 DEX saves."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "elite",
    "key": "lightbend_mantle",
    "text": "+2 TC; cannot be targeted by reaction attacks."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "legendary",
    "key": "cloak_of_vanishing_echoes",
    "text": "+3 TC; vanish as reaction once/scene."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "legendary",
    "key": "spectrum_mirage_veil",
    "text": "+3 TC; if you move, enemies have disadvantage to target you."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "armor",
    "rarity": "legendary",
    "key": "eidolon_weave_suit",
    "text": "+3 TC; appear as multiple illusions; disadvantage for attackers."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "common",
    "key": "phantom_ward_disk",
    "text": "+2 TC vs AoE."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "displacer_shell",
    "text": "+1 TC; +1 DEX saves."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "rare",
    "key": "glimmer_halo_field",
    "text": "+1 TC; 50% miss chance if you used a power this round."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "elite",
    "key": "shadowlight_barrier",
    "text": "+2 TC; redirect one ranged attack/combat."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "legendary",
    "key": "spectral_dome_projector",
    "text": "+2 TC; party within 10 ft gains +1 TC."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "legendary",
    "key": "afterimage_guard",
    "text": "+3 TC; attackers auto-miss on natural 1–4."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "shield",
    "rarity": "legendary",
    "key": "veil_of_the_false_self",
    "text": "+3 TC; DC 15 WIS or attacker hits illusion instead."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "common",
    "key": "decoy_pack",
    "text": "Once/scene, attacker hits your illusion instead."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "hallucinogenic_pulse",
    "text": "+2 TC; attacker −1 to hit for 1 round."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "rare",
    "key": "vanishing_step_locket",
    "text": "Turn invisible as a reaction to being targeted."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "elite",
    "key": "cognitive_distorter",
    "text": "+2 TC; nearby enemies WIS save or become disoriented."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "legendary",
    "key": "mindveil_disruptor",
    "text": "Confuse attackers who miss (WIS DC 16 or skip next attack)."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "legendary",
    "key": "dreamcloak_injector",
    "text": "Reaction: mirror an ally’s TC for 1 round."
  },
  {
    "type": "classgear",
    "class": "illusionist",
    "gear": "utility",
    "rarity": "legendary",
    "key": "infinite_mirror_core",
    "text": "Auto-duplicate once/day to absorb one full attack."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "common",
    "key": "morphweave_skin",
    "text": "+1 TC; alter form as bonus action."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "fluidform_carapace",
    "text": "+2 TC vs grapple/restrain."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "rare",
    "key": "biocoded_shell",
    "text": "+1 TC; +1 CON saves."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "elite",
    "key": "phaseform_hide",
    "text": "+3 TC; enter semi-liquid state."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "legendary",
    "key": "mimics_mantle",
    "text": "Copy target’s TC for 1 round."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "legendary",
    "key": "amorphous_vestige",
    "text": "Immune to critical hits."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "armor",
    "rarity": "legendary",
    "key": "gene_veil_plates",
    "text": "+3 TC; immune to shape detection/identity magic."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "common",
    "key": "chitin_flex_shield",
    "text": "+1 TC; +1 AC if attacking/defending same turn."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "clone_aura_matrix",
    "text": "+2 TC if a clone is active."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "rare",
    "key": "reactive_copy_skin",
    "text": "Once/day gain attacker’s TC for 1 round."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "elite",
    "key": "molten_shell_projection",
    "text": "Create duplicate to block one incoming attack."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "legendary",
    "key": "shifting_scale_dome",
    "text": "+3 TC; attacker −2 to hit next round."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "legendary",
    "key": "skinshard_deflector",
    "text": "Redirect one attack to another target once/day."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "shield",
    "rarity": "legendary",
    "key": "mutamask_guard",
    "text": "Appear as attacker’s ally; attacker has disadvantage."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "common",
    "key": "mimic_reflex_gland",
    "text": "+2 TC vs repeat attacks."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "amorphous_escape_nodes",
    "text": "+2 TC; slither away."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "rare",
    "key": "second_self_implant",
    "text": "Create a false version with your TC."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "elite",
    "key": "shedskin_matrix",
    "text": "+3 TC; leave behind a skin clone as decoy."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "legendary",
    "key": "evo_regen_coil",
    "text": "Shift form to regain 1d6 SP and +2 TC."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "legendary",
    "key": "bio_reflex_prism",
    "text": "+2 TC; auto-evade 1 melee attack/day."
  },
  {
    "type": "classgear",
    "class": "shape_shifter",
    "gear": "utility",
    "rarity": "legendary",
    "key": "echo_soul_fragment",
    "text": "Clone acts with your TC and mimics one ability."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "common",
    "key": "flameproof_mantle",
    "text": "+2 TC vs fire."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "uncommon",
    "key": "cryo_insulated_shell",
    "text": "+2 TC vs cold."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "rare",
    "key": "stormbreaker_harness",
    "text": "+1 TC; resist lightning."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "elite",
    "key": "stoneguard_core",
    "text": "+3 TC; immunity to knockdown."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "legendary",
    "key": "terra_wardframe",
    "text": "+3 TC; +2 TC while on natural terrain."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "legendary",
    "key": "voltaic_veinsuit",
    "text": "Reflect a lightning attack once/day."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "armor",
    "rarity": "legendary",
    "key": "cinderguard_sheath",
    "text": "Ignore all Burn; +2 TC vs fire."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "common",
    "key": "elemental_ward_totem",
    "text": "+1 TC vs elemental."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "uncommon",
    "key": "volcanic_shell_plate",
    "text": "+2 TC; 1 fire damage to melee attackers."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "rare",
    "key": "tempest_veil_sigil",
    "text": "+2 TC for 1 round (spend 1 SP)."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "elite",
    "key": "galehalo_barrier",
    "text": "+3 TC vs ranged; deflects projectiles."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "legendary",
    "key": "frostwall_core",
    "text": "+2 TC; slows melee attackers."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "legendary",
    "key": "wildfire_halo",
    "text": "All enemies within 5 ft take 1d4 fire when you’re hit."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "shield",
    "rarity": "legendary",
    "key": "planar_barrier_cloak",
    "text": "Immunity to one chosen element per long rest."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "common",
    "key": "living_ember_core",
    "text": "+2 TC when hit by elemental power."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "uncommon",
    "key": "earthbind_grips",
    "text": "+2 TC while grounded."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "rare",
    "key": "stormstep_cloak",
    "text": "+2 TC in elemental terrain."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "elite",
    "key": "cyclone_core_belt",
    "text": "Spend 1 SP to become immune to AoE for 1 turn."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "legendary",
    "key": "heart_of_the_infernaut",
    "text": "Spend SP to ignite: +3 TC and fire damage aura."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "legendary",
    "key": "aetherflow_gauntlet",
    "text": "Float/fly; +2 TC while airborne."
  },
  {
    "type": "classgear",
    "class": "elemental_controller",
    "gear": "utility",
    "rarity": "legendary",
    "key": "oceans_calm_pendant",
    "text": "Auto-nullify 1 elemental power/day."
  }
]
;

  // Simple retrieval by keyword overlap
  function retrieve(q, k=14){
    const terms=q.toLowerCase().split(/[^a-z0-9]+/).filter(Boolean);
    return CODEX.map(e=>{
      const hay=((e.type||"")+" "+(e.key||"")+" "+(e.text||"")+" "+(e.class||"")+" "+(e.gear||"")+" "+(e.rarity||"")).toLowerCase();
      let s=0; for(const t of terms) if(hay.includes(t)) s++;
      return {e,s};
    }).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).slice(0,k).map(x=>x.e);
  }

  function buildUser(q){
    const ctx = retrieve(q, 14);
    const ctxLines = ctx.map(e=>{
      if(e.type==="gear")      return `- [gear:${e.gear}.${e.key}] (${e.rarity}) ${e.text}`;
      if(e.type==="classgear") return `- [classgear:${e.class}.${e.gear}.${e.key}] (${e.rarity}) ${e.text}`;
      return `- [${e.type}:${e.key}] ${e.text}`;
    });
    const flags = { gmMode: gm.checked, spoilerSafe: sp.checked };
    const ctxBlock = ctxLines.length ? "Local Codex:\n"+ctxLines.join("\n")+"\n\n" : "";
    return `${ctxBlock}Flags: ${JSON.stringify(flags)}\nQuestion:\n${q}\n`;
  }

  async function send(){
    const q = msg.value.trim(); if(!q) return;
    msg.value=""; append("cc-user", q); const reply=append("", "…thinking…");

    const payload = {
      model: selModel.value,
      stream: true,
      system: SYSTEM_PROMPT,
      messages: [{ role: "user", content: buildUser(q) }],
      temperature: 0.7
    };

    const r = await fetch(PROXY_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if (!r.ok || !r.body) { reply.textContent = "Error contacting assistant."; return; }

    const reader = r.body.getReader(); const decoder = new TextDecoder("utf-8"); let agg="";
    while (true) {
      const { value, done } = await reader.read(); if (done) break;
      const chunk = decoder.decode(value, { stream:true });
      const lines = chunk.split("\n").filter(Boolean);
      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const data = line.slice(6); if (data === "[DONE]") continue;
          try { const json = JSON.parse(data); const delta = json.choices?.[0]?.delta?.content || ""; agg += delta; reply.textContent = agg; }
          catch { agg += line; reply.textContent = agg; }
        } else { agg += line; reply.textContent = agg; }
      }
    }
  }

  const toggle = (show)=>{ modal.style.display = show? "block":"none"; modal.setAttribute("aria-hidden", show? "false":"true"); if(show) msg.focus(); };
  [openBtn, menuAI].forEach(btn => btn && btn.addEventListener("click", () => toggle(true)));
  closeBtn.addEventListener("click", () => toggle(false));
  modal.addEventListener("click", (e) => { if (e.target===modal) toggle(false); });
  sendBtn.addEventListener("click", send);
  msg.addEventListener("keydown", (e) => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }});
</script>
</body>
</html>
